var JSpectraViewer={version:"0.1"};void 0===window.JSV&&(window.JSV=JSpectraViewer);(function(e){e.inherits=function(d,b){d.prototype=Object.create(b.prototype)};e.initialize=function(){e._viewers=new e.SVSet;e.viewers=function(d){return e._viewers.get(d)}}})(JSpectraViewer);
(function(e){var d=function(b,c){var a=this;this.container=d3.select(b);c=c||{};this.title=c.title;this.width=e.default_for(c.width,800);this.height=e.default_for(c.height,400);this.tick_count=e.default_for(c.tick_count,10);this.tick_length=e.default_for(c.tick_length,10);this.tick_precision=e.default_for(c.tick_precision,3);this.axis_x_tick_format=d3.format(e.default_for(c.axis_x_tick_format,".g"));this.axis_y_tick_format=d3.format(e.default_for(c.axis_y_tick_format,".g"));this.axis_x_title=e.default_for(c.axis_x_title,
"ppm");this.axis_y_title=e.default_for(c.axis_y_title,"Intensity");this.axis_y_show=e.default_for(c.axis_y_show,!1);this.axis_x_show=e.default_for(c.axis_x_show,!0);this.axis_y_grid=e.default_for(c.axis_y_grid,!1);this.axis_x_grid=e.default_for(c.axis_x_grid,!1);this.axis_x_reverse=e.default_for(c.axis_x_reverse,!0);this.axis_y_lock=e.default_for(c.axis_y_lock,!1);this.min_boundaries=c.min_boundaries;this.zoom_max=e.default_for(c.zoom_max,100);this.zoombox_show=e.default_for(c.zoombox_show,!0);this.zoombox_size=
e.default_for(c.zoombox_size,15);this.legend_show=e.default_for(c.legend_show,!0);this.simplify_tolerance=c.simplify_tolerance;this.debug=e.default_for(c.debug,!1);this.debug_data={time:{},data:{},drag:{},zoom:{},zbox:{}};var g=e.viewers().map(function(a){return a.id});this.id=e.default_for(c.id,e.unique_id("jsv-",1,g));this.axis_y_gutter=this.axis_y_show?e.default_for(c.axis_y_gutter,60):0;this.axis_x_gutter=this.axis_x_show?e.default_for(c.axis_x_gutter,50):0;this.container.html(this.title?"<h3>"+
this.title+"</h3>":"").style("width",this.width+2+"px");this.sv_wrapper=this.container.append("div").attr("class","sv-wrapper").style("position","relative");this.container.append("div").attr("class","sv-key-down").style("display","none");this.canvas=this.sv_wrapper.append("canvas").attr("id",this.container.attr("id")).attr("class","spectra-viewer "+this.class).style({border:"1px solid #DDD"}).attr("width",this.width).attr("height",this.height).node();if(!this.canvas.getContext)throw this.container.html("<h3>Spectra Viewer requires Canvas, which is not supported by this browser.</h3>"),
"Canvas not supported";e.pixel_ratio=e.get_pixel_ratio(this.canvas);e.scale_resolution(this.canvas,e.pixel_ratio);this.font=this.adjust_font();this.axis_title_font=this.adjust_font(1,void 0,"bold");this.context=this.canvas.getContext("2d");this.context.setLineDash||(this.context.setLineDash=function(){});this.scaled_height=e.pixel(this.height-this.axis_x_gutter);this.scaled_width=e.pixel(this.width-this.axis_y_gutter);this.scale=new e.SVScale;this.scale.y.range([this.scaled_height,0]);this.scale.x.range(this.x_range());
this.boundary=new e.SVScale;this.boundary.x.range(this.x_range());this.boundary.y.range([this.scaled_height,0]);this.boundary.clamp(!0);this.min_boundaries&&(this.boundary.update(this.min_boundaries),this.scale.update(this.min_boundaries));this._spectra=new e.SVSet;this.svg=this.sv_wrapper.append("svg").attr("width",this.width).attr("height",this.height).attr("class","svg-viewer").style("position","absolute").style("top",0).style("left",0);this.svg.style("cursor","all-scroll");this.drag_drop_load=
e.default_for(c.drag_drop_load,!0);this.initialize_zooming();this.initialize_dragging();this.initialize_brushing();a.legend=new e.SVLegend(a);d3.select(window).on("keydown",function(){a.keydown()}).on("keyup",function(){a.keyup()});this.svg.on("mousemove",function(){var b=d3.mouse(a.canvas);a.mx=a.scale.x.invert(e.pixel(b[0]));a.my=a.scale.y.invert(e.pixel(b[1]));a.highlight.hover();a.annotation.check_hover()});this.svg.on("mouseover",function(){a.contains_mouse=!0;document.activeElement.blur()});
this.svg.on("mouseout",function(){a.contains_mouse=!1});this.handlers=new e.SVEvents;this.on=this.handlers.on;this.off=this.handlers.off;this.trigger=this.handlers.trigger;this.drag_drop_load&&this.initialize_drag_drop_load();this.selection=new e.SVSelection(this,e.default_for(c.select,{}));this.annotation=new e.SVAnnotation(a);this.zoombox=new e.ZoomBox(a);this.zoombox.visible=this.zoombox_show;this.highlight=new e.SVHighlighter(this,e.default_for(c.highlight,{}));this.menu=new e.SVMenu(a);this.help=
new e.SVHelp(a);this.initial_settings();this.cluster_navigation_id=c.cluster_navigation_id;c.structure&&(this.structure=new e.SVStructure(c.structure));c.assignment_table&&(this.assignment_table=new e.SVAssignments(a,c.assignment_table));e._viewers.push(this);this.draw()};d.prototype.toString=function(){return"SpectraViewer"};Object.defineProperties(d.prototype,{drag_drop_load:{get:function(){return this._drag_drop_load},set:function(b){if(this._drag_drop_load=b)this.initialize_drag_drop_load();else this.svg.on(".dragndrop",
null)}},cluster_navigation_id:{get:function(){return this._cluster_navigation_id},set:function(b){(this._cluster_navigation_id=b)?this._cluster_navigation=new e.SVClusterNavigator(this,b):this._cluster_navigation&&(this._cluster_navigation.detach(),this._cluster_navigation=void 0)}},structure_viewer_id:{get:function(){return this._structure_viewer_id},set:function(b){(this._structure_viewer_id=b)?this._structure_viewer=new e.SVStructure(this,b):this._structure_viewer&&(this._structure_viewer.detach(),
this._structure_viewer=void 0)}}});d.prototype.x_range=function(b){b=b||this.width;var c=e.pixel(b-this.axis_y_gutter);return this.axis_x_reverse?[c,0]:[e.pixel(this.axis_y_gutter),e.pixel(b)]};d.prototype.resize=function(b,c,a){this.width=b||this.width;this.height=c||this.height;this.container.style("width",this.width+"px");d3.select(this.canvas).attr("width",this.width).attr("height",this.height);this.font=this.adjust_font();this.axis_title_font=this.adjust_font(1,void 0,"bold");this.scaled_height=
e.pixel(this.height-this.axis_x_gutter);this.scaled_width=e.pixel(this.width-this.axis_y_gutter);this.scale.y.range([this.scaled_height,0]);this.boundary.y.range([this.scaled_height,0]);this.scale.x.range(this.x_range());this.boundary.x.range(this.x_range());this.svg.attr("width",this.width).attr("height",this.height);e.scale_resolution(this.canvas,e.pixel_ratio);this.zoombox.update();this.legend.update();this.draw(a)};d.prototype.keyval=function(){return d3.select(".sv-key-down").html()};d3.selection.prototype.moveToFront=
function(){return this.each(function(){this.parentNode.appendChild(this)})};d.prototype.keydown=function(){d3.event[this.zoom_brush_key]&&d3.selectAll(".sv-wrapper .svg-viewer").style("cursor","crosshair");d3.selectAll(".sv-key-down").html(d3.event.keyCode)};d.prototype.keyup=function(){16==d3.event.keyCode&&d3.selectAll(".sv-wrapper .svg-viewer").style("cursor","all-scroll");d3.selectAll(".sv-key-down").html("")};d.prototype.pixels_to_units_of_axis=function(b,c){return this.scale[b].invert(e.pixel(c))-
this.scale[b].invert(0)};d.prototype.set_zoom_axis=function(b){b?"y"!=this.zoom_axis&&(this.zoom_axis="y",this.zoom_behavior.scale(this.zoom_y),this.set_zoom_cursor(b)):"x"!=this.zoom_axis&&(this.zoom_axis="x",this.zoom_behavior.scale(this.zoom_x),this.set_zoom_cursor(b))};d.prototype.set_zoom_cursor=function(b){b?this.svg.style("cursor","ns-resize"):this.svg.style("cursor","ew-resize")};d.prototype.scale_axis=function(b,c){var a=Math.abs(this.boundary[b].domain()[0]-this.boundary[b].domain()[1])/
c,g="x"===b?0:1,g=this.scale[b].invert(this.mouse(this.canvas)[g]),f=(g-this.scale[b].domain()[0])/Math.abs(this.scale[b].domain()[0]-this.scale[b].domain()[1]);"y"==b&&(f=0,g=this.scale.y.domain()[0]);var d=[g-a*f,g+a*(1-f)];this.scale[b].domain(d);this.set_domain(b,d);this.debug&&(b=b.toUpperCase(),this.debug_data.zoom["d"+b]=e.round(a),this.debug_data.zoom["v"+b]=e.round(g),this.debug_data.zoom["r"+b]=e.round(f))};d.prototype.mouse=function(b){return d3.mouse(b).map(function(b){return e.pixel(b)})};
d.prototype.translate_axis=function(b,c){var a=this.scale[b].range().map(function(a){return a-e.pixel(c)}).map(this.scale[b].invert);this.set_domain(b,a)};d.prototype.move_to=function(b,c){var a=this;c=c||500;!1!==this.axis_y_lock&&(b[1][0]=this.axis_y_lock_value(b[1]));var g=[],f=[],g=g.concat.apply(g,b),f=f.concat.apply(f,[a.scale.x.domain(),a.scale.y.domain()]);d3.select(this.canvas).transition().duration(c).tween("move",function(){var b=d3.interpolateArray(f,g);return function(c){a.set_domain("x",
[b(c)[0],b(c)[1]]);a.set_domain("y",[b(c)[2],b(c)[3]]);a.fast_draw()}}).each("end",function(){a.full_draw()});a.zoom_axis=""};d.prototype.set_domain=function(b,c){var a=this.boundary,g=Math.abs(a[b].domain()[1]-a[b].domain()[0]),f=Math.abs(c[1]-c[0]);"y"==b&&!1!==this.axis_y_lock&&(c[0]=this.axis_y_lock_value(c),c[1]=c[0]+f);var d=g/f;if(d>this.zoom_max){var d=this.zoom_max,f=g/d,l=(c[0]+c[1])/2;c[0]=l-f/2;c[1]=c[0]+f;this.debug&&(this.debug_data.zoom["center-"+b]=e.round(l),this.debug_data.zoom["domain-diff-"+
b]=e.round(f))}1>d&&(d=1,f=g/d,c[0]=a[b].min(),c[1]=a[b].max());this["zoom_"+b]!=d&&(this["zoom_"+b]=d,this.trigger("zoom"));c[0]<a[b].domain()[0]?(c[0]=a[b].domain()[0],c[1]=c[0]+f):c[1]>a[b].domain()[1]&&(c[1]=a[b].domain()[1],c[0]=c[1]-f);this.scale[b].domain(c);this.trigger("domain-change")};d.prototype.axis_y_lock_value=function(b){return!0===this.axis_y_lock?this.boundary.y.domain()[0]:0-Math.abs(b[1]-b[0])*this.axis_y_lock};d.prototype.zoom_out_completely=function(){this.move_to([this.boundary.x.domain(),
this.boundary.y.domain()]);this.scale.x.domain(this.boundary.x.domain());this.scale.y.domain(this.boundary.y.domain());this.zoom_y=this.zoom_x=1};d.prototype.add_spectrum=function(b,c,a){var g=(new Date).getTime(),f=d3.max(this.spectra().map(function(a){return a.xy_data.length()}));f||(f=4E4);this.points_per_ppm=f/(this.boundary.x.domain()[1]-this.boundary.x.domain()[0]);b.tolerance=e.default_for(b.tolerance,this.simplify_tolerance);b.number_of_points=e.default_for(b.number_of_points,f);b.min_x=e.default_for(b.min_x,
this.boundary.x.domain()[0]);b.max_x=e.default_for(b.max_x,this.boundary.x.domain()[1]);f=this.all_spectra().map(function(a){return a.name});b.id=e.default_for(b.id,e.unique_id("Spectrum_",1,f));if(b.xy_line&&"string"==typeof b.xy_line.x)if(f=b.xy_line.x,this.spectra(f))b.xy_line.x=this.spectra(f).xy_data.x;else throw Error("There is no spectrum with the id provided by '"+b.id+"' xy_line.x:"+f);c="Spectrum"==b.toString()?b:new e.Spectrum(b,c,a);c._sv=this;this._spectra.push(c);this.boundary.update(c.xy_data);
this.scale.update(c.xy_data);this.zoombox.update();this.legend.update();this.debug&&(this.debug_data.time[b.id+"~add"]=e.elapsed_time(g),this.debug_data.data[b.id+"~noise"]=c.noise,this.debug_data.data[b.id+"~points-all"]=c.xy_data.length(),this.debug_data.data[b.id+"~points-simple"]=c.simple_xy_data.length());this.draw()};d.prototype.add_bayesil_data=function(b){this.add_spectrum({id:"Spectrum",xy_line:b.spectrum_xy},void 0,b.meta);this.add_spectrum(e.convert_bayesil_data(b))};d.prototype.replace_bayesil_data=
function(b,c){var a=[this.scale.x.domain(),this.scale.y.domain()],g=0<this.spectra().length;this.remove_all_spectra();this.add_bayesil_data(b);g&&c&&(this.set_domain("x",a[0]),this.set_domain("y",a[1]));this.draw()};d.prototype.add_nmrml_data=function(b){var c=this;if(window.X2JS){var a=b.match(/<spectrumDataArray.*compressed="(true|false)"[^]*>(.*)<\/spectrumDataArray>/);if(a){for(var a=e.convert_base64_to_float64(a[2],"true"==a[1]),g={x:[],y:[]},f=0;f<a.length;f+=2)g.x.push(a[f]),g.y.push(a[f+1]);
c.add_spectrum({id:"Spectrum",display:{color:"black"},xy_line:g})}else console.log("No Spectrum Data Array found");if(a=b.match(/<atomAssignment[^]*<\/atomAssignment>/)){a=a[0];g=a.match(/<structure[^]*<\/structure>/);if(c.structure&&g){if(f=a.match(/<identifier.*name="(.*?)"/))c.structure.title=f[1];c.structure.read_nmrml(g[0])}b=b.match(/acquisitionNucleus.*name=\"(.*?)\"/);if(c.assignment_table&&b)if(b=b[1],b.match(/hydrogen/i)||b.match(/1H/i))c.assignment_table.nmr_nucleus="1H";else if(b.match(/carbon/i)||
b.match(/13C/i))c.assignment_table.nmr_nucleus="13C";a=(new X2JS).xml_str2json(a);b={name:a.atomAssignment.chemicalCompound.identifierList.identifier._name};var d=[];if(a=a.atomAssignment.atomAssignmentList.multiplet)a=Array.isArray(a)?a:[a],a.forEach(function(a,b){var c=[],g=a.peakList.peak,g=Array.isArray(g)?g:[g];g.forEach(function(a){a={center:parseFloat(a._center),amplitude:parseFloat(a._amplitude)};a.width=parseFloat(a._width)||.005;c.push(a)});d.push({peaks:c,meta:{nmrml_cluster_index:b}})});
b.clusters=d;c.add_spectrum({id:"Assignment",display:{color:"blue"},compounds:[b]});if(c.structure&&a){var l=c.compounds(c.compounds().length).clusters();a.forEach(function(a,b){var g=l.find(function(a){return a.meta.nmrml_cluster_index==b});if(a.atoms&&g){var f=[],d=a.atoms._atomRefs;d&&d.match(/\w/)&&(f=d.trim().split(/\s+/));g.atom_refs=f;g._atoms.merge(c.structure.atoms(f));switch(a.multiplicity._accession){case "NMR:1000194":g.multiplet_type="s";break;case "NMR:1000184":g.multiplet_type="d";
break;case "NMR:1000185":g.multiplet_type="t";break;case "NMR:1000186":g.multiplet_type="q";break;case "NMR:1000192":g.multiplet_type="dd";break;case "NMR:1000195":g.multiplet_type="qunit";break;case "NMR:1000196":g.multiplet_type="dt";break;case "NMR:1000197":g.multiplet_type="td";break;case "NMR:1400305":g.multiplet_type="m"}}})}c.spectra("Assignment").labels.update_peaks();c.trigger("adjust-end")}else console.log("Could not read nmrML. No <atomAssignment> tag found.")}else console.log("X2JS needs to be installed to read nmrML: https://github.com/abdmob/x2js")};
d.prototype.remove_spectra=function(b){this._spectra=new e.SVSet(this._spectra.filter(function(c){return c.id!=b}));this.zoombox.remove_spectra(b);this.legend.update()};d.prototype.remove_all_spectra=function(){var b=this;b.selection.clear();this.all_spectra().forEach(function(c){b.remove_spectra(c.id)});b.reset_boundaries()};d.prototype.reset_boundaries=function(){this.selection.clear();this.boundary.initialized=!1;this.scale.initialized=!1;this.min_boundaries?(this.boundary.update(this.min_boundaries),
this.scale.update(this.min_boundaries)):(this.boundary.update({x:[0,1],y:[0,1]}),this.scale.update({x:[0,1],y:[0,1]}))};d.prototype.spectra=function(b){return b?this._spectra.get(b):(new e.SVSet(this._spectra.filter(function(b){return b.active}))).get(b)};d.prototype.all_spectra=function(b){return this._spectra.get(b)};d.prototype.compounds=function(b){for(var c=new e.SVSet,a=0,g=this._spectra.length;a<g;a++)c.merge(this._spectra[a].compounds());return c.get(b)};d.prototype.clusters=function(b){for(var c=
new e.SVSet,a=0,g=this._spectra.length;a<g;a++)c.merge(this._spectra[a].clusters());return c.get(b)};d.prototype.peaks=function(b){for(var c=new e.SVSet,a=0,g=this._spectra.length;a<g;a++)c.merge(this._spectra[a].peaks());return c.get(b)};d.prototype.clear=function(){this.context.clearRect(0,0,e.pixel(this.width),e.pixel(this.height))};d.prototype.draw=function(b,c,a){var g=(new Date).getTime();b=b||!1;var f=this.context,d=this.scale;this.clear();this.axis_y_grid&&this.draw_grid_lines("y");this.axis_x_grid&&
this.draw_grid_lines("x");this.spectra().forEach(function(g){g.compounds().draw(f,d,b,c,a);g.clusters().draw(f,d,b,c,a);g.peaks().draw(f,d,b,!0,a);g.draw(f,d,b,c,a)});this.selection.draw(f,d,b,c,a);this.zoombox.set_zoom_area(this.scale);this.annotation.draw();this.legend_show&&this.legend.draw();this.draw_axes();this.selection.draw_bounds(f,d);this.selection.draw_indicators(f,d);this.debug&&(this.debug_data.time.draw=e.elapsed_time(g),this.draw_debug(this.legend.bottom()))};d.prototype.full_draw=
function(){var b=this.scale.x.domain()[1]-this.scale.x.domain()[0],b=this.points_per_ppm*b;3<Math.abs(this.scale.x.range()[1]-this.scale.x.range()[0])/b?this.draw(!1,!0,1):this.draw(!1,!1)};d.prototype.calc_draw=function(){this.draw(!1,!0,1)};d.prototype.fast_calc_draw=function(){this.draw(!1,!0,2)};d.prototype.fast_draw=function(){10>this.zoom_x?this.draw(!0):this.draw()};d.prototype.flash=function(b){this.context.font=this.adjust_font(1.5);this.context.textAlign="center";this.context.textBaseline=
"center";var c=e.pixel(this.width)/2,a=e.pixel(this.height)/2;this.context.fillText(b,c,a)};d.prototype.draw_debug=function(b){if(this.debug){var c=this.context,a=this.debug_data;c.font=this.adjust_font(1,"monospace");c.fillStyle="black";var g=e.pixel(18);b=b||0;if(this.axis_x_reverse){var f=e.pixel(10);c.textAlign="left"}else f=e.pixel(this.width-10),c.textAlign="right";var d=0;(!0===this.debug?Object.keys(a):this.debug).forEach(function(e){Object.keys(a[e]).forEach(function(h){c.fillText(e+"|"+
h+": "+a[e][h],f,b+g*d);d+=1})})}};d.prototype.adjust_font=function(b,c,a){c=c||"Sans-Serif";a=a||"";b=9/1400*(b||1)*e.pixel(this.width)+e.pixel(5);return a+" "+b+"pt "+c};d.prototype.draw_axes=function(){var b=this.scale;this.context.strokeStyle="black";this.context.lineWidth=1;this.context.setLineDash([1,0]);var c=e.pixel(this.axis_y_gutter),a=e.pixel(this.axis_x_gutter);this.context.clearRect(b.x.range_min(),b.y.range_max(),b.x.range_max()+c,a);var g=this.axis_x_reverse?b.x.range_max():0;this.context.clearRect(g,
b.y.range_min(),c,b.y.range_max()+a);this.context.fillStyle="black";this.axis_y_show&&this.draw_y_axis();this.axis_x_show&&this.draw_x_axis()};d.prototype.draw_x_axis=function(){var b=this,c=e.pixel(this.tick_length),a=this.context,g=this.scale;a.beginPath();a.moveTo(g.x.range()[1],g.y.range()[0]);a.lineTo(g.x.range()[0],g.y.range()[0]);a.stroke();a.textAlign="center";a.textBaseline="top";a.font=this.font;g.x.ticks(this.tick_count).forEach(function(f){a.beginPath();a.moveTo(g.x(f),g.y.range()[0]);
a.lineTo(g.x(f),g.y.range()[0]+c);a.stroke();rounded_tick_x=d3.round(f,b.tick_precision);a.fillText(b.axis_x_tick_format(rounded_tick_x),g.x(f),g.y.range()[0]+c)});if(this.axis_x_title){a.font=this.axis_title_font;var f=g.x.range_diff()/2,d=g.y.range()[0]+3*c;a.fillText(this.axis_x_title,f,d)}};d.prototype.draw_y_axis=function(){var b=this,c=this.context,a=this.scale,g=this.axis_x_reverse?1:-1,f=g*e.pixel(this.tick_length),d=a.x.range()[0]+g*e.pixel(this.tick_length+5);c.beginPath();c.moveTo(a.x.range()[0],
a.y.range()[1]);c.lineTo(a.x.range()[0],a.y.range()[0]);c.stroke();c.textAlign=this.axis_x_reverse?"left":"right";c.textBaseline="middle";c.font=this.font;var l=0;a.y.ticks(this.tick_count).forEach(function(g){c.beginPath();c.moveTo(a.x.range()[0],a.y(g));c.lineTo(a.x.range()[0]+f,a.y(g));c.stroke();c.fillText(b.axis_y_tick_format(g),d,a.y(g));b.axis_y_title&&(g=Number(c.measureText(g).width),g>l&&(l=g))});if(this.axis_y_title){var h=e.pixel(4),p=e.pixel(this.axis_y_gutter),n=/(\d+\.?\d*)pt/.exec(this.axis_title_font)[1];
l+Math.abs(f)+Number(n)+h+5<p&&(c.save(),c.textAlign="center",c.textBaseline="middle",c.font=this.axis_title_font,h=a.x.range()[0]+(p-h-Number(n)/2)*g,p=a.y.range()[0]/2,c.translate(h,p),c.rotate(g*Math.PI/2),c.translate(-h,-p),c.fillText(this.axis_y_title,h,p),c.restore())}};d.prototype.draw_grid_lines=function(b){var c=this.context,a=this.scale;a[b].ticks(this.tick_count).forEach(function(g){c.beginPath();"y"==b?(c.moveTo(a.x.range()[0],a.y(g)),c.lineTo(a.x.range()[1],a.y(g))):"x"==b&&(c.moveTo(a.x(g),
a.y.range()[0]),c.lineTo(a.x(g),a.y.range()[1]));c.strokeStyle="rgb(210,210,210)";c.lineWidth=e.pixel(.5);c.stroke()});this.context=c};d.prototype.draw_y_axis2=function(){var b=this,c=this.context,a=this.scale,g=d3.min(a.x.range()),f=d3.max(a.x.range()),d=d3.min(a.y.range()),l=d3.max(a.y.range()),h,p,n;this.axis_y_left?(h=g,p=h-e.pixel(this.tick_length+5),c.textAlign="right",n=-e.pixel(this.tick_length)):(h=f,p=h+e.pixel(this.tick_length+5),c.textAlign="left",n=e.pixel(this.tick_length));c.beginPath();
c.moveTo(h,d);c.lineTo(h,l);c.stroke();c.textBaseline="middle";c.font=this.font;var m=0;a.y.ticks(this.tick_count).forEach(function(g){c.beginPath();c.moveTo(h,a.y(g));c.lineTo(h+n,a.y(g));c.stroke();c.fillText(g,p,a.y(g));b.axis_y_title&&(g=Number(c.measureText(g).width),g>m&&(m=g))});this.axis_y_title&&(g=e.pixel(4),f=e.pixel(this.axis_y_gutter),d=/(\d+)pt/.exec(this.axis_title_font)[1],m+n+Number(d)+g<f&&(c.save(),c.textAlign="center",c.textBaseline="hanging",c.font=this.axis_title_font,c.rotate(Math.PI/
2),g=-a.x.range()[0]-f+g,f=a.y.range()[0]/2,c.fillText(this.axis_y_title,f,g),c.restore()))};d.prototype.get_peak_domains=function(b,c){for(var a=b[0],g=b[0],f=1;f<b.length;f++){var d=b[f];d.center<a.center&&(a=d);d.center>g.center&&(g=d)}f=e.xy_from_peaks(b,1E3,a.center,g.center);f=d3.max(f.y);c?(a=a.center-a.width/2,g=g.center+g.width/2):(a=a.center-a.width,g=g.center+g.width,d=.1*(g-a),a-=d,g+=d,f+=.1*f);return[[a,g],[0,f]]};d.prototype.move_to_compound=function(b,c,a){c=(b=this.spectra(b))&&b.compounds(c);
this.move_to_peaks(c.peaks(),a)};d.prototype.move_to_peaks=function(b,c,a){a=a||1;b=this.get_peak_domains(b);b[1][1]*=a;var g=Math.abs(b[0][1]-b[0][0]);b[0][0]-=g-g/a;b[0][1]+=g-g/a;this.move_to(b,c)};d.prototype.set_domain_to_brush_extent=function(b,c){var a=this.domains_from_brush_extent(b,c);this.set_domain("x",a[0]);this.set_domain("y",a[1])};d.prototype.domains_from_brush_extent=function(b,c){var a=[b[0][0],b[1][0]],g=[b[0][1],b[1][1]];c&&(scale=this.scale,a=a.map(function(a){return e.pixel(scale.x(a))}).map(scale.x.invert),
g=g.map(function(a){return e.pixel(scale.y(a))}).map(scale.y.invert));return[a,g]};d.prototype.elements=function(b,c,a,g){var f=a;a||(c=e.default_for(c,this),"string"==typeof c&&(c=this.spectra(c)),f=c?"peak"==b?c.peaks():"cluster"==b?c.clusters():"compound"==b?c.compounds():"spectrum"==b?c.spectra():new e.SVSet:new e.SVSet);g&&(f=new e.SVSet(f.filter(function(a){return a.visible})));return f};d.prototype.find_element_mouse_over=function(b,c,a,g){var f=this,d;elements=f.elements(b,c,a,g);elements.forEach(function(a){a.y_for_mouse_x=
e.sum_of_peaks(f.mx,a.peaks())});elements.order_by("y_for_mouse_x");for(b=0;b<elements.length;b++)if(f.my<=elements[b].y_for_mouse_x&&0<=f.my){d=elements[b];break}return d};d.prototype.max_y_in_range=function(b,c){};d.prototype.image=function(b,c){b=b||this.width;c=c||this.height;var a=this.context,g=this.zoombox.visible,f=d3.select("body").append("canvas").attr({width:b,height:c}).node();e.scale_resolution(f,e.pixel_ratio);this.context=f.getContext("2d");var d=e.pixel(c-this.axis_x_gutter);this.scale.x.range(this.x_range(b));
this.scale.y.range([d,0]);this.zoombox.visible=!1;this.full_draw();image=f.toDataURL();this.scale.x.range(this.x_range());this.scale.y.range([this.scaled_height,0]);this.context=a;this.zoombox.visible=g;d3.select(f).remove();return image};d.prototype.initial_settings=function(){var b=this;this.settings=new e.SVSettings(this,{title:"JSV Settings",width:"250",height:"210",settings:[{label:"Grid lines [y-axis]",property:"axis_y_grid",type:"boolean"},{label:"Grid lines [x-axis]",property:"axis_x_grid",
type:"boolean"},{label:"Show Zoombox",property:function(c){if(0==arguments.length)return b.zoombox.visible;b.zoombox.visible=c},type:"boolean"},{label:"Show Legend",property:"legend_show",type:"boolean"}]})};e.SpectraViewer=d})(JSpectraViewer);
(function(e){e.SpectraViewer.prototype.initialize_dragging=function(){var d=this;d.drag_event=!1;d.drag_behavior=d3.behavior.drag().on("dragstart",function(){d.drag_event=!0;d3.event.sourceEvent.preventDefault();d.svg.style("cursor","all-scroll");d.trigger("drag-start")}).on("drag",function(){var b=(new Date).getTime();d.translate_axis("x",d3.event.dx);d.translate_axis("y",d3.event.dy);d.trigger("drag");d.fast_draw();d.debug&&(console.log("dragging"),d.debug_data.time.drag=e.elapsed_time(b),d.debug_data.drag.dX=
e.round(d3.event.dx),d.debug_data.drag.dY=e.round(d3.event.dy),d.debug_data.drag.zX=e.round(d.zoom_x),d.debug_data.drag.zY=e.round(d.zoom_y))}).on("dragend",function(){d.drag_event=!1;d.trigger("drag-end");d.full_draw()});d.svg.call(d.drag_behavior)};e.SpectraViewer.prototype.initialize_zooming=function(){var d=this;d.zoom_behavior=d3.behavior.zoom().x(d3.scale.linear()).scaleExtent([1,d.zoom_max]).on("zoomstart",function(){if(!d.drag_event){var b=d3.event.sourceEvent[d.zoom_y_key];d.set_zoom_axis(b);
d.set_zoom_cursor(b);d.trigger("zoom-start")}}).on("zoom",function(){if(!d.drag_event){var b=(new Date).getTime();d.set_zoom_axis(d3.event.sourceEvent[d.zoom_y_key]);d.scale_axis(d.zoom_axis,d.zoom_behavior.scale());d.fast_draw();d.debug&&(console.log("zooming"),d.debug_data.time.zoom=e.elapsed_time(b),d.debug_data.zoom.zX=e.round(d.zoom_x),d.debug_data.zoom.zY=e.round(d.zoom_y))}}).on("zoomend",function(){d.drag_event||(d.svg.style("cursor","all-scroll"),d.trigger("zoom-end"),d.full_draw())});d.svg.call(d.zoom_behavior).on("dblclick.zoom",
null);d.zoom_x=1;d.zoom_y=1;d.zoom_axis="x";d.zoom_y_key="altKey"};e.SpectraViewer.prototype.initialize_brushing=function(){var d=this;d.brush=d3.svg.brush().x(d.scale.x).y(d.scale.y).on("brushstart",function(){b=d.scale.x.invert(d3.event.sourceEvent.offsetX);d3.event.sourceEvent[d.zoom_brush_key]?(d3.event.sourceEvent.stopPropagation(),d3.event.sourceEvent.preventDefault(),d.svg.selectAll(".zoom-brush").attr("class","zoom-brush active-brush"),d.brush_event=!0,d.svg.style("cursor","crosshair")):(d.svg.selectAll(".zoom-brush").attr("class",
"zoom-brush empty-brush"),d.brush_event=!1);d.svg.selectAll(".zoom-brush .background").attr("height","400")}).on("brush",function(){var c=d.brush.extent(),a=d.scale.x.invert(d3.event.sourceEvent.offsetX);if(a<=b)var g=a,a=b;else g=b;var f=d.scale.y.invert(d.scale.y(d.scale.y.domain()[0])/e.pixel_ratio),k=d.scale.x.invert(d.scale.x(d.scale.x.domain()[0])/e.pixel_ratio);if(!1!==d.axis_y_lock)var l=f,c=d.scale.y.invert(d3.mouse(d.svg.node())[1]),f=d.scale.y.domain()[1],c=c>f?f:c,c=c<l?l:c;else l=c[0][1],
l=l<f?f:l,c=c[1][1],c=c<f?f:c;d.brush.extent([[g<k?k:g,l],[a<k?k:a,c]]);d.svg.selectAll(".zoom-brush").call(d.brush);d.debug&&console.log("brushing-"+d.brush_event)}).on("brushend",function(){if(d.brush_event){if(d.brush.empty()&&d3.event.sourceEvent.altKey)d.zoom_out_completely();else{var b=d.domains_from_brush_extent(d.brush.extent(),!0);d.move_to(b)}d.svg.style("cursor","all-scroll");d.brush_event=!1}d.brush.clear();d.svg.selectAll(".zoom-brush").call(d.brush)});d.brush_g=d.svg.append("g").attr("class",
"zoom-brush active-brush").call(d.brush);d.svg.selectAll(".zoom-brush rect.background").style("cursor","");d.svg.selectAll(".resize").style("cursor","");d.zoom_brush_key="altKey";var b};e.SpectraViewer.prototype.initialize_drag_drop_load=function(){var d=this;this.svg.on("dragleave.dragndrop",function(b){d3.event.preventDefault();d3.event.stopPropagation();d.draw()});this.svg.on("dragover.dragndrop",function(b){d3.event.preventDefault();d3.event.stopPropagation();d.draw();d.flash("Drop Bayesil JSON File...")});
this.svg.on("drop.dragndrop",function(){d3.event.preventDefault();d3.event.stopPropagation();d.draw();var b=d3.event.dataTransfer.files[0];d.flash('Loading "'+b.name+'"...');var c=new FileReader;d.json_file=b;c.onload=function(){var a=c.result;try{var b=JSON.parse(a);d.replace_bayesil_data(b,!0);d.trigger("drop")}catch(f){d.draw(),d.flash("Could not read file: "+f.message)}};c.readAsText(b)})}})(JSpectraViewer);
(function(e){var d=function(){this.x=e.LinearScale();this.y=e.LinearScale();this.initialized=!1};d.prototype.clamp=function(b){this.x.clamp(b);this.y.clamp(b)};d.prototype.update=function(b){var c=this.initialized?this.x.max():null,a=this.initialized?this.x.min():null,g=this.initialized?this.y.max():null,f=this.initialized?this.y.min():null,c=d3.max(b.x.concat(c)),a=d3.min(b.x.concat(a)),g=d3.max(b.y.concat(g));b=d3.min(b.y.concat(f));this.x.domain([a,c]);this.y.domain([b,g]);this.initialized=!0};
e.LinearScale=function(){var b=d3.scale.linear();b.min=function(c){if(!arguments.length)return b.domain()[0];if(c>b.max())throw Error("x must be less than domain max: "+b.max());b.domain([c,b.max()]);return b};b.max=function(c){if(!arguments.length)return b.domain()[1];if(c<b.min())throw Error("x must be greater than domain min: "+b.min());b.domain([b.min(),c]);return b};b.diff=function(){return Math.abs(b.max()-b.min())};b.range_diff=function(){return Math.abs(b.range()[1]-b.range()[0])};b.range_min=
function(){return d3.min(b.range())};b.range_max=function(){return d3.max(b.range())};return b};e.SVScale=d})(JSpectraViewer);
(function(e){var d=function(c,a){this.callback=a;this.event_type=c.replace(/\..*/,"");this.namespace=b(c)},b=function(b){return(result=b.match(/\.(.*)/))?result[1]:void 0};e.SVEvents=function(){var c={};this.on=function(b,f){a(b);var e=b.replace(/\..*/,"");c[e]||(c[e]=[]);c[e].push(new d(b,f))};this.off=function(g,f){a(g);var d=g.replace(/\..*/,""),e=b(g);1==arguments.length?e?d?c[d]=c[d].filter(function(a){return a.namespace!=e}):Object.keys(c).forEach(function(a){c[a]=c[a].filter(function(a){return a.namespace!=
e})}):c[d]=void 0:c[d]=c[d].filter(function(a){return a.callback!=f})};this.trigger=function(g,f){a(g);var d=g.replace(/\..*/,""),e=b(g);Array.isArray(c[d])&&c[d].forEach(function(a){e?a.namespace==e&&a.callback.call(null,f):a.callback.call(null,f)})};var a=function(a){if("string"!=typeof a)throw Error("Type must be a string");}}})(JSpectraViewer);
(function(e){function d(b,a,g){return g.indexOf(b)===a}var b=function(){1==arguments.length&&Array.isArray(arguments[0])?this.push.apply(this,arguments[0]):0<arguments.length&&this.push.apply(this,arguments)};b.prototype=Object.create(Array.prototype);b.prototype.toString=function(){return"SVSet"};b.prototype.merge=function(b){this.push.apply(this,b);return this};b.prototype.attr=function(b){if(1==arguments.length&&"object"==typeof b)for(var a=Object.keys(b),g=a.length,f=0,d=this.length;f<d;f++)for(var e=
0;e<g;e++)this[f][a[e]]=b[a[e]];else if(2==arguments.length)for(a=0,g=this.length;a<g;a++)this[a][arguments[0]]=arguments[1];else if(void 0!=b)throw Error("attr(): must be 2 arguments or a single object");return this};b.prototype.draw=function(b,a,g,f,d){for(var e=0,h=this.length;e<h;e++)this[e].draw(b,a,g,f,d);return this};b.prototype.each=function(b){for(var a=0,g=this.length;a<g;a++)b.call(this[a],a,this);return this};b.prototype.contains=function(b){return 0<=this.indexOf(b)};b.prototype.remove=
function(c){var a;return a=new b(this.filter(function(a){return a!=c}))};b.prototype.empty=function(){return 0==this.length};b.prototype.present=function(){return 0<this.length};b.prototype.order_by=function(b,a){0<this.length&&("function"===typeof this[0][b]?this.sort(function(a,f){return a[b]()>f[b]()?1:a[b]()<f[b]()?-1:0}):this.sort(function(a,f){return a[b]>f[b]?1:a[b]<f[b]?-1:0}));a&&this.reverse();return this};b.prototype.lineWidth=function(b){for(var a=0,g=this.length;a<g;a++)this[a].lineWidth=
b;return this};b.prototype.get=function(c){if(void 0==c)return this;if(Number.isInteger(c))return this[c-1];if("string"==typeof c)return c.match(/^path-id-/)?this.filter(function(a){return a.path_id()==c})[0]:c.match(/^label-id-/)?this.filter(function(a){return a.label_id()==c})[0]:this.filter(function(a){return a.id==c})[0];if(Array.isArray(c)){var a=this.filter(function(a){return c.some(function(b){return a.id==b})}),g=new b;g.push.apply(g,a);return g}return new b};b.prototype.equals=function(b){if("SVSet"!=
b.toString()&&!Array.isArray(b))return!1;var a=this.unique(),g=b.unique(),d=!0;if(a.length!=g.length)return!1;a.forEach(function(a){g.contains(a)||(d=!1)});return d};b.prototype.unique=function(){return new b(this.filter(d))};b.prototype.find=function(b,a){if("function"!==typeof b)throw new TypeError("predicate must be a function");for(var g=Object(this),d=g.length>>>0,e,l=0;l<d;l++)if(e=g[l],b.call(a,e,l,g))return e};e.SVSet=b})(JSpectraViewer);
(function(e){var d=function(b){void 0===b&&(b={x:[],y:[]});if(b instanceof Array){for(var c=[],a=[],g=[],d=0,e=b.length;d<e;d++)c.push(b[d].x),a.push(b[d].y),b[0].yi&&g.push(b[d].yi);c={x:c,y:a};b[0]&&b[0].yi&&(c.yi=g);b=c}if(b.x.length!=b.y.length)throw Error("x and y must be the same length!");if(b.yi&&b.yi.length!=b.x.length)throw Error("If present yi must be the same length as x and y!");this.x=(g=b.x[0]>b.x[b.x.length-1])?b.x.reverse():b.x;this.y=g?b.y.reverse():b.y;this.yi=b.yi&&g?b.yi.reverse():
b.yi};d.prototype.length=function(){return this.x.length};d.prototype.asArray=function(){for(var b=[],c,a=0,g=this.length();a<g;a++)c={x:this.x[a],y:this.y[a]},this.yi&&(c.yi=this.yi[a]),b.push(c);return b};d.prototype.index_of=function(b,c){return e.index_of_value(this.x,b,c)};d.prototype.simplify=function(b,c){return new d(e.simplify(this,b,c))};e.SVData=d})(JSpectraViewer);
(function(e){path_id=0;var d=function(b,c){b=b||{};this.meta=c||{};this.lineWidth=e.default_for(b.lineWidth,1);this.color=e.default_for(b.color,"black");this.visible=e.default_for(b.visible,!0);this.dash=e.default_for(b.dash,[]);this.fill=b.fill;this.path_id()};d.prototype.peaks=function(){return new e.SVSet};d.prototype.path_id=function(){var b="path-id-"+path_id++;this.path_id=function(){return b};return b};d.prototype.attr=function(b){for(var c=Object.keys(b),a=0,g=c.length;a<g;a++)this[c[a]]=
b[c[a]];return this};d.prototype.display_settings=function(b){return b?this.attr(b):{color:this.color,fill:this.fill,lineWidth:this.lineWidth,visible:this.visible,dash:this.dash}};d.prototype.data_for_draw=function(b,c,a,g){var d=void 0!=this.xy_data;if(this.phasing&&d&&void 0!=this.xy_data.yi){g=[];c=this.xy_data.length();for(a=0;a<c;a++)b=Math.PI*(1*this.ph0+1*(c-a-1)*this.ph1/c)/180,g.push(Math.cos(b)*this.xy_data.y[a]+Math.sin(b)*this.xy_data.yi[a]);b={x:this.xy_data.x,y:g}}else a&&0<this.peaks().length||
!d&&0<this.peaks().length?(g||(g=1),c=b.x.range_diff()/e.pixel_ratio/g,g=1<g,b=e.xy_from_peaks(this.peaks(),c,b.x.domain()[0],b.x.domain()[1],g)):d?b=c?this.simple_xy_data:this.xy_data:(b={x:[0],y:[0]},console.log("No data or Peaks for SVPath:"),console.log(this));return b};d.prototype.draw=function(b,c,a,g,d){if(this.visible){a=this.data_for_draw(c,a,g,d);d=e.index_of_value(a.x,c.x.domain()[0],!1);g=e.index_of_value(a.x,c.x.domain()[1],!0);b.translate(.5,.5);b.beginPath();var k=this.fill?c.y(0):
c.y(a.y[d]);for(b.moveTo(c.x(a.x[d]),k);d<=g;d++)b.lineTo(c.x(a.x[d]),c.y(a.y[d]));this.fill&&(b.lineTo(c.x(a.x[g]),c.y(0)),b.fillStyle=this.fill,b.fill());b.lineWidth=e.default_for(this.lineWidth,1);b.strokeStyle=this.color;b.setLineDash(this.dash);b.stroke();b.translate(-.5,-.5)}};e.SVPath=d})(JSpectraViewer);
(function(e){function d(a,b,c,d){this.x=a;this.y=b;this.width=c;this.height=d}function b(a){var b=this;this.sv=a;this.margin_top=e.pixel(5);this.margin_side=e.pixel(10);this.key_label_space=e.pixel(5);this.key_width=e.pixel(10);this.line_width=e.pixel(3);this.text_height=e.pixel(18);this.items=[];a.svg.on("mousedown.legend",function(){for(var c=a.mouse(a.canvas),d=0,e=b.items.length;d<e;d++)item=b.items[d],item.rect.contains_pt(c[0],c[1])&&(item.path.visible=!item.path.visible,a.full_draw())})}function c(a,
b,c){this.legend=a;this.sv=a.sv;this.path=b;this.rect=c}d.prototype.contains_pt=function(a,b){return a>=this.x&&a<=this.x+this.width&&b>=this.y&&b<=this.y+this.height};b.prototype.bottom=function(){var a=(this.sv.zoombox.visible?e.pixel(this.sv.zoombox.height):0)+this.margin_top;return this.sv.legend_show?this.offset_y:a};b.prototype.update=function(){var a=this.sv,b=a.context;this.offset_y=(a.zoombox.visible?e.pixel(a.zoombox.height):0)+this.margin_top;var c=this.margin_side;b.font=a.adjust_font(1,
"monospace");this.items=[];for(var k=0;k<a.spectra().length;k++){var l=a.spectra()[k],h=new e.SVLegendItem(this),p=new d;p.y=this.offset_y;p.height=this.text_height;p.width=this.key_width+this.key_label_space+b.measureText(l.name).width;p.x=a.axis_x_reverse?c:e.pixel(a.width)-c-p.width;h.rect=p;h.path=l;this.offset_y+=this.text_height;this.items.push(h)}};b.prototype.draw=function(){var a=this.sv,b=a.context;b.save();b.textAlign="left";b.textBaseline="middle";b.font=a.adjust_font(1,"monospace");for(a=
0;a<this.items.length;a++)this.items[a].draw();b.restore()};c.prototype.key_x1=function(){return this.sv.axis_x_reverse?this.rect.x:this.rect.x+this.rect.width-this.legend.key_width};c.prototype.key_x2=function(){return this.key_x1()+this.legend.key_width};c.prototype.key_y=function(){return this.rect.y+this.rect.height/2};c.prototype.label_x=function(){return this.sv.axis_x_reverse?this.rect.x+this.legend.key_width+this.legend.key_label_space:this.rect.x};c.prototype.draw=function(){var a=this.rect;
this.sv.context.clearRect(a.x,a.y,a.width,a.height);this.path.visible&&this.draw_key();this.draw_label()};c.prototype.draw_key=function(){var a=this.sv.context;a.beginPath();a.moveTo(this.key_x1(),this.key_y());a.lineTo(this.key_x2(),this.key_y());a.lineWidth=this.legend.line_width;a.strokeStyle=this.path.color;a.setLineDash(this.path.dash);a.stroke()};c.prototype.draw_label=function(){this.sv.context.fillStyle=this.path.visible?"black":"#999";this.sv.context.fillText(this.path.name,this.label_x(),
this.key_y())};e.SVLegend=b;e.SVLegendItem=c})(JSpectraViewer);
(function(e){function d(a,b){b=b||{};var c=this;this.sv=a;this.highlighted_label;this.point_gap=e.default_for(b.point_gap,e.pixel(12));this.label_color=e.default_for(b.label_color,"#5555DD");this.visible=e.default_for(b.visible,!0);this.hover=e.default_for(b.hover,!0);this.labels=new e.SVSet;this.visible_labels=new e.SVSet;a.svg.on("mousedown.label",function(){c.highlighted_label&&c.hover&&a.trigger("label-click",c.highlighted_label)})}function b(a){a=a||{};this.spectrum=a.spectrum;this.labels=new e.SVSet}
function c(a,b,c,d){b=b||{};display_defaults={vertical:!0,font_size:12};c=e.merge(display_defaults,b.display,c);this.meta=e.merge(b.meta,d);this.label_set=a;this.vertical=c.vertical;this.font_size=c.font_size;this.text=b.text;this.x=b.x;this.y=b.y;this.stack_level=0;this.label_id()}function a(a,b,c,d){this.x=a;this.y=b;this.width=c;this.height=d}d.prototype.get=function(a){return this.labels.get(a)};d.prototype.update=function(){var a=this.sv,b=a.labels?a.labels.get():new e.SVSet;a.spectra().forEach(function(a){a.visible&&
a.active&&a.labels&&b.push.apply(b,a.labels.get())});this.labels=b;a=this.reduce_labels_by_view();a=this.reduce_labels_by_height(a);this.visible_labels=a=this.adjust_labels(a)};d.prototype.rect_for_label=function(b){var c=this.sv,d,l=c.scale.x(b.x);d=c.scale.y(b.y);var c=c.context.measureText(b.text).width,h=e.pixel(b.font_size);b.vertical?(b=l-h/2,d=d-c-this.point_gap):(b=l-c/2,d=d-h-this.point_gap);return new a(b,d,h,c)};d.prototype.reduce_labels_by_view=function(a){a||(a=this.labels);var b=this.sv.scale;
return a.filter(function(a){return a.x>b.x.min()&&a.x<b.x.max()&&a.y<b.y.max()})};d.prototype.reduce_labels_by_height=function(a){a||(a=this.labels);for(var b=new e.SVSet,c=0,d=a.length;c<d;c++)label=a[c],label.font_size=6,label.rect=this.rect_for_label(label),label.adjust_rect(b),3>label.stack_level&&b.push(label);return b};d.prototype.adjust_labels=function(a){var b=this.sv,c;e.pixel(2);e.pixel(12);var d=13,h=8,p=b.context;p.save();for(var n=!0;n;){n=!1;adjusted_labels=new e.SVSet;p.font=e.pixel(d)+
"px Arial";for(var h=8+d3.round(5*b.zoom_x/b.zoom_max),m=0,q=a.length;m<q;m++)if(c=a[m],c.font_size=d,c.rect=this.rect_for_label(c),c.adjust_rect(adjusted_labels),1<c.stack_level&&d>h){n=!0;--d;break}else adjusted_labels.push(c)}return a};d.prototype.label_over_spectra=function(a,b,c){var d=this.sv;c=[];for(var h=0,p=a.rect.width;h<p;h++)c.push(d.scale.x.invert(a.rect.x+h));a=d.scale.y.invert(a.rect.bottom());d=!1;h=0;for(p=c.length;h<p;h++)if(a<e.sum_of_peaks(c[h],b)){d=!0;break}return d};d.prototype.draw=
function(){if(this.visible){var a=this.sv,b=a.context,a=a.scale,c,d=e.pixel(2);b.save();this.update();for(var h=this.visible_labels,p=0,n=h.length;p<n;p++){c=h[p];var m=a.x(c.x),q=a.y(c.y)-d;c=c.rect.bottom()+d;b.beginPath();b.moveTo(m,q);b.lineTo(m,c);b.strokeStyle="#999999";b.lineWidth=e.pixel(.5);b.stroke()}b.fillStyle=this.label_color;p=0;for(n=h.length;p<n;p++)c=h[p],b.font=c===this.highlighted_label?"bold "+b.font:b.font.replace("bold ",""),b.textBaseline="top",c.vertical?(b.textAlign="right",
b.save(),b.translate(c.rect.x,c.rect.y),b.rotate(-Math.PI/2),b.fillText(c.text,0,0),b.restore()):(b.textAlign="left",b.fillText(c.text,c.rect.x,c.rect.y));b.restore()}};d.prototype.check_hover=function(){var a=this.sv,b;if(this.hover){for(var c=a.scale.x(a.mx),d=a.scale.y(a.my),e=this.highlighted_label,p,n=0,m=this.visible_labels.length;n<m;n++)if(b=this.visible_labels[n],b.rect.contains_pt(c,d)){p=b;break}e!=p&&(this.highlighted_label=p,this.sv.trigger("click-start"),a.full_draw());this.highlighted_label?
a.svg.style("cursor","pointer"):a.svg.style("cursor","move")}};b.prototype.get=function(a){return this.labels.get(a)};b.prototype.add=function(a,b,d){this.labels.push(new c(this,a,b,d))};b.prototype.add_peaks=function(){if(this.spectrum)for(var a=this.spectrum.peaks(),b=0,c=a.length;b<c;b++){var d=a[b],h=e.sum_of_peaks(d.center,d.spectrum().peaks());this.add({x:d.center,y:h,text:d.label()})}};b.prototype.update_peaks=function(){this.spectrum&&(this.labels=new e.SVSet,this.add_peaks())};label_id=0;
c.prototype.label_id=function(){var a="label-id-"+label_id++;this.label_id=function(){return a};return a};c.prototype.adjust_rect=function(a){for(var b=0;this.overlap(a);)this.rect.y-=2*e.pixel(this.font_size),b+=1;this.stack_level=b};c.prototype.overlap=function(a){return this.rect.overlap(a.map(function(a){return a.rect}))};a.prototype.bottom=function(){return this.y+this.height};a.prototype.top=function(){return this.y};a.prototype.left=function(){return this.x};a.prototype.right=function(){return this.x+
this.width};a.prototype.overlap=function(a){for(var b=e.pixel(4),c=!1,d=0,h=a.length;d<h;d++)if(c=a[d],this.x<=c.right()&&c.x<=this.right()+b&&this.y<=c.bottom()&&c.y<=this.bottom()){c=!0;break}else c=!1;return c};a.prototype.contains_pt=function(a,b){return a>=this.x&&a<=this.x+this.width&&b>=this.y&&b<=this.y+this.height};e.SVAnnotation=d;e.SVLabelSet=b;e.SVLabel=c})(JSpectraViewer);
(function(e){function d(b,c,a){var d=this;b=b||{};display_defaults={};c=e.merge(display_defaults,b.display,c);a=e.merge(b.meta,a);e.SVPath.call(this,c,a);this.id=b.id;this.name=b.name||this.id;this.tolerance=b.tolerance;this.noise;this.active=!0;this.xy_data=new e.SVData;this.simple_xy_data=new e.SVData;this.labels=new e.SVLabelSet({spectrum:this});this._compounds=new e.SVSet;b.compounds?b.compounds.forEach(function(a){d.add_compound(new e.Compound(a))}):b.peak_list&&d.add_compound(new e.Compound({clusters:[{peaks:b.peak_list}]}));
if(d.compounds().present()){c=e.default_for(b.number_of_points,1E4);a=e.default_for(b.min_x,-1);var f=e.default_for(b.max_x,10);c=e.xy_from_peaks(d.peaks(),c,a,f);d.add_xy_line(c)}else b.xy_line&&d.add_xy_line(b.xy_line);b.labels&&b.labels.forEach(function(a){d.labels.add(a)})}e.inherits(d,e.SVPath);d.prototype.toString=function(){return"Spectrum"};d.prototype.add_compound=function(b){this._compounds.push(b);b._spectrum=this};d.prototype.update=function(){var b=this._sv,c=e.xy_from_peaks(this.peaks(),
this.xy_data.length(),b.boundary.x.min(),b.boundary.x.max());this.add_xy_line(c);b.zoombox.update()};d.prototype.compounds=function(b){return this._compounds.get(b)};d.prototype.add_xy_line=function(b){this.xy_data=new e.SVData(b);this.noise=this.calculate_noise();this.simple_xy_data=this.xy_data.simplify(this.tolerance||this.noise,!0)};d.prototype.calculate_noise=function(){var b=[-.05,-.04],c=this.xy_data.index_of(b[0]),b=this.xy_data.index_of(b[1]),c=this.xy_data.y.slice(c,b);return(d3.max(c)-
d3.min(c)).toPrecision(2)};d.prototype.clusters=function(b){for(var c=new e.SVSet,a=0,d=this._compounds.length;a<d;a++)c.merge(this._compounds[a].clusters());return c.get(b)};d.prototype.peaks=function(b){var c=new e.SVSet;this.compounds().forEach(function(a){a.clusters().forEach(function(a){c.merge(a.peaks())})});return c.get(b)};Object.defineProperties(d.prototype,{active:{get:function(){return this._active},set:function(b){this._active=b;var c=this._sv;c&&(c.reset_boundaries(),c.all_spectra().each(function(){this.active&&
(c.boundary.update(this.xy_data),c.scale.update(this.xy_data))}),c.zoombox.update(),c.legend.update())}}});e.Spectrum=d})(JSpectraViewer);
(function(e){function d(b,c,a){var d=this;b=b||{};display_defaults={visible:!1};c=e.merge(display_defaults,b.display,c);a=e.merge(b.meta,a);e.SVPath.call(this,c,a);this._clusters=new e.SVSet;b&&(this.id=b.id,this.name=b.name,this.concentration=b.concentration,b.clusters&&b.clusters.forEach(function(a){d.add_cluster(new e.Cluster(a))}));this.update()}e.inherits(d,e.SVPath);d.prototype.toString=function(){return"Compound"};d.prototype.add_cluster=function(b){this._clusters.push(b);b._compound=this};
d.prototype.update=function(){this.x_min=e.peak_min(this.peaks());this.x_max=e.peak_max(this.peaks());this.xy_data=new e.SVData(e.xy_from_peaks(this.peaks(),5E3,this.x_min,this.x_max));this.simple_xy_data=this.xy_data.simplify(5E-4,!0);this._clusters.order_by("center")};d.prototype.clusters=function(b){return this._clusters.get(b)};d.prototype.peaks=function(b){var c=new e.SVSet;this._clusters.forEach(function(a){c.merge(a.peaks())});return c.get(b)};d.prototype.spectrum=function(){return this._spectrum};
d.prototype.intersect=function(b,c,a){b=e.sum_of_peaks(b,this.peaks());return c<=b&&0<=c};d.prototype.display_concentration=function(){return e.round(this.concentration,1)+" \u03bcM"};d.prototype.center=function(){var b;this.peaks().present()&&(b=d3.mean(this.peaks(),function(b){return b.center}));return b};d.prototype.atom_assignment_nmrml=function(){if(window.X2JS){var b=d3.format(".2f"),c=new X2JS,a={atomAssignmentList:{multiplet:[]}};this.clusters().forEach(function(c){var d=[];c.peaks().forEach(function(a){d.push({_center:a.center,
_amplitude:a.amplitude,_width:a.width})});c={_center:b(c.center()),atoms:{_atomRefs:c.atom_refs.join(" ")},multiplicity:c.nmrml_multiplet_json(),peakList:{peak:d}};a.atomAssignmentList.multiplet.push(c)});c=c.json2xml_str(a);return c=c.replace(/><\/peak>/g,"/>")}console.log("X2JS needs to be installed to create nmrML: https://github.com/abdmob/x2js")};e.Compound=d})(JSpectraViewer);
(function(e){function d(a,b,c){var d=this;a=a||{};display_defaults={visible:!1};b=e.merge(display_defaults,a.display,b);c=e.merge(a.meta,c);e.SVPath.call(this,b,c);this._peaks=new e.SVSet;this._atoms=new e.SVSet;this.lower_bound=e.number(a.lower_bound);this.upper_bound=e.number(a.upper_bound);this.weight=e.number(a.weight);this.protons=e.number(a.protons);a.peaks&&a.peaks.forEach(function(a){d.add_peak(new e.Peak(a))})}e.inherits(d,e.SVPath);d.prototype.toString=function(){return"Cluster"};d.prototype.add_peak=
function(a){this._peaks.push(a);this.multiplet_type=void 0;a._cluster=this};d.prototype.update=function(){this._peaks.order_by("center")};d.prototype.peaks=function(a){return this._peaks.get(a)};d.prototype.compound=function(){return this._compound};d.prototype.spectrum=function(){return this.compound().spectrum()};d.prototype.center=function(){var a;this.peaks().present()&&(a=d3.mean(this.peaks(),function(a){return a.center}));return a};d.prototype.atoms=function(a){return this._atoms.get(a)};d.prototype.determine_multiplet_type=
function(){var a=this.peaks(),d="m";1==a.length?d="s":2==a.length?d="d":3==a.length?d="t":4==a.length?d=b(a)?"dd":"q":5==a.length?d="quint":6==a.length&&(d=c(a)?"td":"dt");return d};var b=function(a){a=a.map(function(a){return a.amplitude});var b=d3.max(a),c=.9*b,d=1.1*b;return a.every(function(a){return a>=c&&a<=d})},c=function(a){a=a.map(function(a){return a.amplitude});var b=d3.min(a.slice(2,3));return a.slice(0,1).concat(a.slice(4,5)).every(function(a){return a<=b})};d.prototype.nmrml_multiplet_json=
function(){var a;switch(this.multiplet_type){case "s":a={_cvRef:"NMRCV",_accession:"NMR:1000194",_name:"singlet feature"};break;case "d":a={_cvRef:"NMRCV",_accession:"NMR:1000184",_name:"doublet feature"};break;case "t":a={_cvRef:"NMRCV",_accession:"NMR:1000185",_name:"triplet feature"};break;case "q":a={_cvRef:"NMRCV",_accession:"NMR:1000186",_name:"quatruplet feature"};break;case "dd":a={_cvRef:"NMRCV",_accession:"NMR:1000192",_name:"doublet of doublets feature"};break;case "quint":a={_cvRef:"NMRCV",
_accession:"NMR:1000195",_name:"quintet feature"};break;case "dt":a={_cvRef:"NMRCV",_accession:"NMR:1000196",_name:"doublet of triplets feature"};break;case "td":a={_cvRef:"NMRCV",_accession:"NMR:1000197",_name:"triplet of doublets feature"};break;case "m":a={_cvRef:"NMRCV",_accession:"NMR:1400305",_name:"multiplet feature"};break;default:a={_cvRef:"NMRCV",_accession:"NMR:1400305",_name:"multiplet feature"}}return a};Object.defineProperties(d.prototype,{multiplet_type:{get:function(){this._multiplet_type||
(this._multiplet_type=this.determine_multiplet_type());return this._multiplet_type},set:function(a){this._multiplet_type=a}},atom_refs:{get:function(){return 0<this.atoms().length?this.atoms().map(function(a){return a.id}):this._atom_refs||[]},set:function(a){this._atom_refs=a}}});e.Cluster=d})(JSpectraViewer);
(function(e){function d(b,c,a){b=b||{};display_defaults={visible:!1};c=e.merge(display_defaults,b.display,c);a=e.merge(b.meta,a);e.SVPath.call(this,c,a);this.center=e.number(b.center);this.amplitude=e.number(b.amplitude);this.width=e.number(b.width)}e.inherits(d,e.SVPath);d.prototype.toString=function(){return"Peak"};d.prototype.set_amplitude=function(b){0>=b&&(b=1E-5);this.amplitude=b};d.prototype.set_center=function(b){this.center=b};d.prototype.update=function(){};d.prototype.delete=function(){var b=
this,c=this.cluster(),a=this.compound(),d=this.spectrum(),f=d._sv,k=c._peaks.filter(function(a){return a!=b});c._peaks=new e.SVSet(k);c.multiplet_type=void 0;c.peaks().empty()&&(k=a._clusters.filter(function(a){return a!=c}),a._clusters=new e.SVSet(k));a.peaks().empty()&&(k=d._compounds.filter(function(b){return b!=a}),d._compounds=new e.SVSet(k));d.peaks().empty()&&(k=f._spectra.filter(function(a){return a!=d}),f._spectra=new e.SVSet(k))};d.prototype.peaks=function(){return new e.SVSet(this)};d.prototype.cluster=
function(){return this._cluster};d.prototype.compound=function(){return this.cluster().compound()};d.prototype.spectrum=function(){return this.compound().spectrum()};d.prototype.label=function(){return this.center.toFixed(3)};e.Peak=d})(JSpectraViewer);
(function(e){function d(b,c){e.SVPath.call(this);var a=this;this.sv=b;this.element_type=c.element_type;this.allow_multiselect=e.default_for(c.allow_multiselect,!0);this.allow_adjust=e.default_for(c.allow_adjust,!0);this.allow_width_adjust=e.default_for(c.allow_width_adjust,!0);this.allow_peak_creation=e.default_for(c.allow_peak_creation,!1);this.show_bounds=e.default_for(c.show_bounds,!0);this.show_indicators=e.default_for(c.show_indicators,!1);this.display_info=e.default_for(c.display_info,!0);this.constrain_adjust=
c.constrain_adjust;this.restriction_spectrum_id=c.restriction_spectrum_id;this.possible_elements=c.possible_elements;display_defaults={fill:"rgba(150, 150, 150, 0.2)",visible:!0};this.display_settings(e.merge(display_defaults,c.display));this.handle_spacer=e.pixel(10);this.handle_size=e.pixel(15);this._elements=new e.SVSet;this.initialize_selection_events();this.popup_box=this.sv.sv_wrapper.append("div").attr("class","jsv-select-popup-box").style("visibility","hidden");this.text_container=this.popup_box.append("div").attr("class",
"jsv-select-text-container");this.draw=function(){a.present()&&(d.prototype.draw.apply(this,arguments),a.draw_adjust_handles(arguments[0],arguments[1]));a.present()&&a.display_info?a.show_popup_box():a.hide_popup_box()}}e.inherits(d,e.SVPath);d.prototype.peaks=function(b){for(var c=new e.SVSet,a=0,d=this._elements.length;a<d;a++)c.merge(this._elements[a].peaks());return c.get(b)};d.prototype.elements=function(b){return this._elements.get(b)};d.prototype.clear=function(){this.sv.trigger("selection-clear");
this._elements=new e.SVSet;this.sv.trigger("selection-empty");return this};d.prototype.add_element=function(b){this._elements.push(b);this.sv.highlight.remove();this.sv.trigger("selection-add");return this};d.prototype.remove_element=function(b){this._elements=new e.SVSet(this._elements.filter(function(c){return c!=b}));this.sv.trigger("selection-remove");this.empty()&&this.sv.trigger("selection-empty");return this};d.prototype.size=function(){return this._elements.length};d.prototype.present=function(){return 0<
this._elements.length};d.prototype.empty=function(){return 0==this._elements.length};d.prototype.contains=function(b){return this._elements.contains(b)};d.prototype.delete=function(){this.peaks().each(function(){this.delete()});this.update();this.clear();this.sv.trigger("adjust-end");this.sv.full_draw()};d.prototype.hide_popup_box=function(){this.popup_box.style("visibility","hidden")};d.prototype.show_popup_box=function(){this.popup_box.style("width","100%");this.popup_box.style(this.sv.axis_x_reverse?
"right":"left",this.sv.axis_y_gutter+e.pixel(2)+"px");this.text_container.html(this.info_text());var b=this.text_container.node().offsetWidth+20;this.popup_box.style("visibility","visible").style("width",b+"px")};d.prototype.info_text=function(){var b="",c="",a="",b=this.compounds(),c=this.clusters(),a=this.peaks();if(1==b.length){var d=b[0],b=d.name;void 0!==d.concentration&&b+" ["+d.display_concentration()+"]"}else b=b.length+" compounds";c=1==c.length?"cluster: "+c[0].center().toFixed(3)+" ppm":
c.length+" clusters";a=1==a.length?"peak: "+a[0].center.toFixed(3)+" ppm":a.length+" peaks";return text="<p>"+b+"</p><p>"+c+"</p><p>"+a+"</p>"};d.prototype.compounds=function(b){var c=new e.SVSet;this.peaks().forEach(function(a){c.push(a.compound())});return c.unique().get(b)};d.prototype.clusters=function(b){var c=new e.SVSet;this.peaks().forEach(function(a){c.push(a.cluster())});return c.unique().get(b)};d.prototype.adjust_concentration=function(){return"compound"==this.element_type||"compound"==
this.constrain_adjust};d.prototype.draw_adjust_handles=function(b,c){var a=this.sv;if(this.allow_adjust&&this.allow_width_adjust&&this.present()){var d=this.handle_spacer,e=this.handle_size,k=a.get_peak_domains(this.peaks(),!0),l=c.x(d3.min(k[0])),h=c.x(d3.max(k[0]));a.axis_x_reverse?(this.handle_min_x=l+d,this.handle_max_x=h-d-e,a=-1):(this.handle_min_x=l-d-e,this.handle_max_x=h+d,a=1);k=c.y(d3.max(k[1])/2);this.handle_y=k-e/2;b.translate(.5,.5);b.beginPath();b.strokeStyle="rgba(50, 50, 50, 0.9)";
b.rect(this.handle_min_x,this.handle_y,e,e);b.rect(this.handle_max_x,this.handle_y,e,e);b.stroke();b.beginPath();b.strokeStyle="rgba(150, 150, 150, 0.5)";b.moveTo(l,k);b.lineTo(l-d*a,k);b.moveTo(h,k);b.lineTo(h+d*a,k);b.stroke();b.translate(-.5,-.5)}};d.prototype.draw_bounds=function(b,c){var a=e.pixel(10),d=this.sv,f=this.elements(1);if(this.show_bounds&&1==this.size()&&"function"==typeof f.center&&e.isNumeric(f.center())&&e.isNumeric(f.lower_bound)&&e.isNumeric(f.upper_bound)){f=this.elements(1);
d.get_peak_domains(this.peaks(),!0);var d=c.y.range()[0],k=c.x(f.lower_bound),l=c.x(f.upper_bound),h=c.x(f.center());b.save();b.translate(.5,.5);b.beginPath();b.lineWidth=2;f.center()<f.lower_bound||f.center()>f.upper_bound?(b.strokeStyle="red",b.fillStyle="red"):(b.strokeStyle="blue",b.fillStyle="white");b.moveTo(k,d);b.lineTo(k+a,d-a);b.lineTo(k+a,d+a);b.lineTo(k,d);b.moveTo(l,d);b.lineTo(l-a,d-a);b.lineTo(l-a,d+a);b.lineTo(l,d);b.moveTo(h,d-a);b.lineTo(h,d+a);b.fill();b.stroke();b.translate(-.5,
-.5);b.restore()}};d.prototype.draw_indicators=function(b,c){var a=e.pixel(10);if(this.show_indicators){var d=c.y.range()[0];b.save();b.translate(.5,.5);this.elements().forEach(function(f){f="function"==typeof f.center?f.center():f.center;void 0!==f&&(f=c.x(f),b.beginPath(),b.lineWidth=e.pixel(2),b.strokeStyle="green",b.fillStyle="green",b.moveTo(f,d-a),b.lineTo(f,d+a),b.fill(),b.stroke())});b.translate(-.5,-.5);b.restore()}};d.prototype.mouse_in_handle=function(){var b=this.sv,c;if(this.allow_adjust&&
this.allow_width_adjust&&this.present()){var a=b.scale.x(b.mx),b=b.scale.y(b.my);b>this.handle_y&&b<this.handle_y+this.handle_size&&(a>this.handle_max_x&&a<this.handle_max_x+this.handle_size&&(c="left"),a>this.handle_min_x&&a<this.handle_min_x+this.handle_size&&(c="right"))}return c};d.prototype.mouse_in_selection=function(){var b=this.sv;if(this.present()){b.scale.x(b.mx);b.scale.y(b.my);var c=e.sum_of_peaks(b.mx,this.peaks());return b.my<=c&&0<=b.my}};d.prototype.update=function(){var b=new e.SVSet;
this.constrained_peaks().forEach(function(c){b.push(c,c.cluster(),c.compound(),c.spectrum())});b.unique().forEach(function(b){b.update()})};d.prototype.constrained_peaks=function(){var b=this,c;b.constrain_adjust?(c=new e.SVSet,b.peaks().forEach(function(a){a[b.constrain_adjust]&&c.merge(a[b.constrain_adjust]().peaks())}),c=c.unique()):c=b.peaks();return c};d.prototype.initialize_selection_events=function(){function b(){return m.allow_peak_creation&&(n.create_peak_mode||"65"==n.keyval()||d3.event.metaKey)}
function c(){return m.allow_multiselect&&("83"==n.keyval()||d3.event.shiftKey)}function a(){if(m.mouse_in_handle())return!0;if(b())return!1;var a,d=n.find_element_mouse_over(m.element_type,m.restriction_spectrum_id,m.possible_elements,m.visible_only),e=m.mouse_in_selection();d||e?(c()?m.contains(d)?(m.remove_element(d),a=!1,A=!0):e||(m.add_element(d),a=!0):e?a=!0:(m.clear(),m.add_element(d),A=a=!0),n.fast_calc_draw()):a=!1;return a}function d(){d3.event.stopPropagation();A=!0;t=d3.event.x-q;r=d3.event.y-
u;q=d3.event.x;u=d3.event.y;w=n.pixels_to_units_of_axis("x",t);v=n.pixels_to_units_of_axis("y",r);if(x){var a="right"==x?1:-1;m.peaks().forEach(function(b){b.width-=a*w*2;1E-5>b.width&&(b.width=1E-5)})}else{m.adjust_concentration()&&m.compounds().forEach(function(a){a.orig_amplitude=d3.max(a.peaks(),function(a){return a.amplitude})});var b=m.constrained_peaks();B=d3.max(b,function(a){return a.amplitude});0>=B&&(B=1E-5);b.forEach(function(a){E=a.amplitude+v/B*a.amplitude;a.set_amplitude(E)});m.peaks().forEach(function(a){a.set_center(a.center+
w)});m.adjust_concentration()&&m.compounds().forEach(function(a){var b=d3.max(a.peaks(),function(a){return a.amplitude});a.concentration=a.concentration*b/a.orig_amplitude})}n.trigger("adjust");n.fast_calc_draw()}function f(){m.update();n.svg.style("cursor","grab");n.trigger("adjust-end",m.compounds());n.full_draw()}function k(){z=new e.SVSet;var a=d3.mouse(n.canvas);C=a[0];D=a[1];y=n.svg.append("rect").attr("class","select-box").attr("x",C).attr("y",D).attr("width",0).attr("height",0)}function l(){d3.event.stopPropagation();
A=!0;var a=d3.mouse(n.canvas);x_new=a[0];y_new=a[1];var a=d3.min([C,x_new]),b=d3.min([D,y_new]),c=Math.abs(x_new-C),d=Math.abs(y_new-D);y.attr("x",a).attr("y",b).attr("width",c).attr("height",d);var g=h(a,b,c,d);g.forEach(function(a){m.contains(a)||(m.add_element(a),z.push(a))});z=new e.SVSet(z.filter(function(a){return g.contains(a)?!0:(m.remove_element(a),!1)}));n.fast_draw()}function h(a,b,c,d){var g=new e.SVSet;d=n.scale.y.invert(e.pixel(b+d));for(var f=n.elements(m.element_type,m.restriction_spectrum_id,
m.possible_elements,m.visible_only),l=0,k=f.length;l<k;l++)for(var h=f[l],p=0;p<c;p++)if(b=n.scale.x.invert(e.pixel(a+p)),d<e.sum_of_peaks(b,h.peaks())){g.push(h);break}return g}function p(){var a,b;m.present()?(a=m.peaks(1).cluster(),b=d3.mean(m.peaks(),function(a){return a.width})):(b=m.restriction_spectrum_id?n.spectra(m.restriction_spectrum_id):n.spectra().filter(function(a){return a.compounds().present()})[0],a=new e.Cluster,b.compounds(1).add_cluster(a),b=b.peaks().present()?d3.mean(b.peaks(),
function(a){return a.width}):.003);b=new e.Peak({width:b,center:0});a.add_peak(b);var c=n.mouse(n.canvas);b.set_center(n.scale.x.invert(c[0]));b.set_amplitude(n.scale.y.invert(c[1]));n.trigger("adjust-peak-created",b);"peak"==m.element_type?m.add_element(b):m.empty()&&"cluster"==m.element_type?m.add_element(a):m.empty()&&"compound"==m.element_type&&m.add_element(a.compound());f()}var n=this.sv,m=this,q,u,t,r,w,v,x,y,z,C,D,B,E,A;n.svg.on("mousedown.selection",function(){A=!1;var e=d3.event.x,h=d3.event.y;
if(a()&&m.allow_adjust)q=d3.event.x,u=d3.event.y,x=m.mouse_in_handle(),n.svg.style("cursor","grabbing"),n.svg.on("mousemove.fit",function(){d()}),n.svg.on("mouseup.fit",function(){f();n.svg.on("mousemove.fit",null);n.svg.on("mouseup.fit",null)});else if(c()&&!m.mouse_in_handle()&&!n.find_element_mouse_over(m.element_type,m.restriction_spectrum_id,m.possible_elements,m.visible_only)&&m.allow_multiselect)k(),n.svg.on("mousemove.fit",function(){l()}),n.svg.on("mouseup.fit",function(){y.remove();n.full_draw();
n.svg.on("mousemove.fit",null);n.svg.on("mouseup.fit",null)});else n.svg.on("mouseup.selection",function(){e==d3.event.x&&h==d3.event.y&&(b()?p():A||m.clear());n.svg.on("mouseup.selection",null)})})};e.SVSelection=d})(JSpectraViewer);
(function(e){function d(b,c){this.sv=b;this.element_type=c.element_type;this.restriction_spectrum_id=c.restriction_spectrum_id;this.possible_elements=c.possible_elements;this.visible_only=e.default_for(c.visible_only,!0);this.text_display=e.default_for(c.text_display,!0);display_defaults={lineWidth:3,visible:!0};this.display=e.merge(display_defaults,c.display);this.popup_box=this.sv.sv_wrapper.append("div").attr("class","jsv-highlight-popup-box").style("visibility","hidden");this.text_container=this.popup_box.append("div").attr("class",
"jsv-highlight-text-container")}d.prototype.hover=function(){var b=this.sv;if(this.element_type){var c=this.highlighted_element,a=b.find_element_mouse_over(this.element_type,this.restriction_spectrum_id,this.possible_elements,this.visible_only);if(b.selection.mouse_in_selection()||b.selection.mouse_in_handle())a=void 0;c!=a&&(this.highlighted_element=a,c&&(c.display_settings(this.saved_display_settings),this.hide_popup_box()),a&&(this.saved_display_settings=a.display_settings(),a.display_settings(this.display),
this.show_popup_box()),b.full_draw())}};d.prototype.remove=function(){this.highlighted_element&&(this.highlighted_element.display_settings(this.saved_display_settings),this.highlighted_element=void 0,this.hide_popup_box())};d.prototype.hide_popup_box=function(){this.sv.trigger("highlight-end");this.popup_box.style("visibility","hidden")};d.prototype.show_popup_box=function(){var b="";!0===this.text_display?b=this.default_text():"string"==typeof this.text_display&&(b=this.parsed_text());this.sv.trigger("highlight-start");
if(this.text_display){this.popup_box.style("width","100%");this.text_container.html(b);var b=this.text_container.node().offsetWidth+20,c=this.sv.menu.visible()?this.sv.menu.height()+5:15;this.popup_box.style("visibility","visible").style("top",c+"px").style("width",b+"px")}};d.prototype.default_text=function(){var b="";"peak"==this.element_type?b="Peak: "+d3.round(this.highlighted_element.center,3)+" ppm":"cluster"==this.element_type?b="Cluster: "+d3.round(this.highlighted_element.center(),3)+" ppm":
"compound"==this.element_type?b=this.highlighted_element.name:"spectrum"==this.element_type&&(b=this.highlighted_element.name);return b};d.prototype.parsed_text=function(){var b=this.highlighted_element;return this.text_display.replace(/#\{(.):(.*?)\}/g,function(c,a,d){var e;"p"==a?e=b[d]:"f"==a?e=b[d]():"m"==a&&(e=b.meta[d]);return e})};e.SVHighlighter=d})(JSpectraViewer);
(function(e){function d(a,b){var c=this;this.sv=a;this.id=b;this.speed=400;this.active_ids=[];this.container=d3.select(b);this.static_compounds;this.table=this.container.append("table").style("display","none").attr("class","jsv-cluster-navigator");this.thead=this.table.append("thead");this.tbody=this.table.append("tbody");a.on("selection-add.cluster-navigator",function(){c.table.style("display","block");c.update_table()});a.selection.present()&&a.trigger("selection-add.cluster-navigator");a.on("selection-remove.cluster-navigator",
function(){c.update_table()});a.on("adjust-end.cluster-navigator",function(){c.update_table()});a.on("selection-empty.cluster-navigator",function(){c.static_compounds||c.table.style("display","none")});d3.select(".jsv-cluster-navigator").on("click",function(){var a=d3.select(d3.event.target);window.getSelection().removeAllRanges();a.classed("cluster-unit")?c.move_to_cluster(a.node()):a.classed("jsv-cluster-nav")&&c.cycle_clusters(a)})}d.prototype.update_table=function(){var a=this.static_compounds||
this.sv.selection.compounds();this.tbody.html(b(a));0<this.active_ids.length&&d3.selectAll(this.active_ids.join(",")).classed("active",!0);this.sv.trigger("cluster-navigator-updated")};var b=function(a){return a.map(function(a){html="<tr>";void 0!==a.name&&(html+="<td>"+a.name+"</td>");void 0!==a.concentration&&(html+="<td>"+a.display_concentration()+"</td>");return html+="<td>"+c(a.clusters())+"</td></tr>"}).join("")},c=function(a){a.order_by("center",!0);return"<span class='jsv-cluster-nav jsv-cluster-nav-left'>&#10094;</span>&nbsp;<span class='jsv-cluster-nav jsv-cluster-nav-right'>&#10095;</span>"+
a.map(function(a){return'<span class="cluster-unit" id="'+a.path_id()+'">'+a.center().toFixed(2)+"</span>"}).join("")};d.prototype.cycle_clusters=function(a){var b=a.classed("jsv-cluster-nav-right");a=d3.select(a.node().parentNode);var c=a.select(".active"),d=a.selectAll(".cluster-unit")[0].map(function(a){return a.id}),c=c.node()?d.indexOf(c.node().id):-1,c=0>c?0:b?c+1<d.length?c+1:0:0>c-1?d.length-1:c-1,b=a.select("#"+d[c]);this.move_to_cluster(b.node())};d.prototype.move_to_cluster=function(a){var b=
sv.clusters(a.id);sv.move_to_peaks(b.peaks(),this.speed,2);d3.select(a.parentNode).selectAll(".cluster-unit").classed("active",!1);d3.select(a).classed("active",!0);this.active_ids=d3.selectAll(".cluster-unit.active")[0].map(function(a){return"#"+a.id});sv.selection.clear();sv.selection.add_element(b)};d.prototype.detach=function(){this.sv.off(".cluster-navigator");this.table.remove()};Object.defineProperties(d.prototype,{static_compounds:{get:function(){return this._static_compounds},set:function(a){this._static_compounds=
a;this.table.style("display","block");this.update_table()}}});e.SVClusterNavigator=d})(JSpectraViewer);
(function(e){function d(a){var b=this;this.sv=a;this.slide_time=500;this._visible=!0;this.menu=a.sv_wrapper.append("div").style("visibility","hidden").attr("class","jsv-menu").on("click",function(){window.getSelection().removeAllRanges()});this.menu_svg=this.menu.append("svg").attr("width",this.width()).attr("height",this.height());this.handle=a.sv_wrapper.append("div").attr("class","jsv-menu-handle").on("click",function(){b.opened()?b.close():b.open()}).on("mouseover",function(){b.handle_mouseover()}).on("mouseout",
function(){b.handle_mouseout()});this.handle_svg=this.handle.append("svg").attr("width",40).attr("height",12);this.stroke_width=4;this.handle_data_closed=[{x:0,y:0},{x:20,y:12-this.stroke_width},{x:40,y:0}];this.handle_data_opened=[{x:0,y:12},{x:20,y:this.stroke_width},{x:40,y:12}];this.draw();a.trigger("domain-change.menu");this.close(0)}d.prototype.visible=function(a){if(0==arguments.length)return this._visible;a?(this._visible=!0,this.handle.style("visibility","visible"),this.menu.style("visibility",
"visible")):(this._visible=!1,this.handle.style("visibility","hidden"),this.menu.style("visibility","hidden"))};d.prototype.opened=function(){return"visible"==this.menu.style("visibility")};d.prototype.width=function(){return 300};d.prototype.height=function(){return 41};d.prototype.open=function(a){a=e.default_for(a,this.slide_time);this.menu.style("visibility","visible");this.menu.transition().duration(a).style("top","0px").style("opacity",1);this.handle_path.transition().duration(a).attr("d",p(this.handle_data_opened))};
d.prototype.close=function(a){a=e.default_for(a,this.slide_time);this.menu.transition().duration(a).style("top","-50px").style("opacity",0).each("end",function(){d3.select(this).style("visibility","hidden")});this.handle_path.transition().duration(a).attr("d",p(this.handle_data_closed))};d.prototype.handle_mouseover=function(){this.handle_path.transition().duration(200).attr("stroke","black")};d.prototype.handle_mouseout=function(){this.handle_path.transition().duration(200).attr("stroke","grey")};
d.prototype.draw=function(){var d=this.sv,q=this,u;this.handle_path=this.handle_svg.append("path").attr("d",p(this.handle_data_closed)).attr("stroke","grey").attr("stroke-width",this.stroke_width).attr("fill","none");var t=c(this.menu_svg,[{x:11,y:4},{x:4,y:15},{x:11,y:26}]),r=c(this.menu_svg,[{x:4,y:4},{x:11,y:15},{x:4,y:26}]);this.nav_group=this.menu_svg.append("g");this.scroll_left_button=h(this.nav_group,0,0,15,30,t);this.scroll_right_button=h(this.nav_group,17,0,15,30,r);this.nav_group.attr("transform",
"translate(7,4)");this.scroll_left_button.on("mousedown",function(){if(!d3.select(this).classed("disabled"))return u=b(d,"x",5,4),!1});this.scroll_right_button.on("mousedown",function(){if(!d3.select(this).classed("disabled"))return u=b(d,"x",-5,4),!1});$(document).mouseup(function(){u&&(clearInterval(u),d.full_draw())});this.zoom_group=this.menu_svg.append("g");this.zoom_y_minus_button=h(this.zoom_group,6,18,16,16,g(this.menu_svg));this.zoom_y_plus_button=h(this.zoom_group,6,0,16,16,a(this.menu_svg));
this.zoom_x_minus_button=h(this.zoom_group,25,9,16,16,g(this.menu_svg));this.zoom_x_plus_button=h(this.zoom_group,43,9,16,16,a(this.menu_svg));f(this.zoom_group,0,.5,5,34,0);f(this.zoom_group,25.5,32,5,34,-90);this.zoom_group.attr("transform","translate(55,2)");this.zoom_x_minus_button.on("click",function(){if(!d3.select(this).classed("disabled")){var a=d.scale.x.diff()/2,a=[[d.scale.x.min()-a,d.scale.x.max()+a],d.scale.y.domain()];d.move_to(a)}});this.zoom_x_plus_button.on("click",function(){if(!d3.select(this).classed("disabled")){var a=
d.scale.x.diff()/4,a=[[d.scale.x.min()+a,d.scale.x.max()-a],d.scale.y.domain()];d.move_to(a)}});this.zoom_y_minus_button.on("click",function(){if(!d3.select(this).classed("disabled")){var a=d.scale.y.diff()/2,a=[d.scale.x.domain(),[d.scale.y.min()-a,d.scale.y.max()+a]];d.move_to(a)}});this.zoom_y_plus_button.on("click",function(){if(!d3.select(this).classed("disabled")){var a=d.scale.y.diff()/4,a=[d.scale.x.domain(),[d.scale.y.min()+a,d.scale.y.max()-a]];d.move_to(a)}});d.on("domain-change.menu",
function(){1==d.zoom_x?q.zoom_x_minus_button.classed("disabled",!0):d.zoom_x>=d.zoom_max?q.zoom_x_plus_button.classed("disabled",!0):(q.zoom_x_minus_button.classed("disabled",!1),q.zoom_x_plus_button.classed("disabled",!1));1==d.zoom_y?q.zoom_y_minus_button.classed("disabled",!0):d.zoom_y>=d.zoom_max?q.zoom_y_plus_button.classed("disabled",!0):(q.zoom_y_minus_button.classed("disabled",!1),q.zoom_y_plus_button.classed("disabled",!1));d.scale.x.min()==d.boundary.x.min()?q.scroll_right_button.classed("disabled",
!0):q.scroll_right_button.classed("disabled",!1);d.scale.x.max()==d.boundary.x.max()?q.scroll_left_button.classed("disabled",!0):q.scroll_left_button.classed("disabled",!1)});help_icon=this.menu_svg.append("text").attr({x:15,y:24,"font-family":"sans-serif","font-size":"26px","stroke-width":1,fill:"black","class":"jsv-button-text"}).style("text-anchor","middle").text("?");this.help_button=h(this.menu_svg,260,4,30,30,help_icon);this.help_button.on("click",function(){d.help.dialog.open()});download_group=
l(this.menu_svg).attr("transform","translate(5,7)");this.download_button=h(this.menu_svg,220,4,30,30,download_group);this.download_dialog=new e.SVDialog(d,{header_text:"Save Image",content_text:'<div class="jsv-alert">Display the viewer image in a new window to download or print. Note that you must allow pop-ups!</div><div><label class="jsv-label">Width</label><div class="jsv-input-group"><input class="jsv-input" id="jsv-save-width" type="text" value="'+d.width+'" /><div class="jsv-input-addon">px</div></div></div><div><label class="jsv-label">Height</label><div class="jsv-input-group"><input class="jsv-input" id="jsv-save-height" type="text" value="'+
d.height+'" /><div class="jsv-input-addon">px</div></div></div>',buttons:{Cancel:function(){this.close()},Generate:function(){n(d,this)}},width:400,height:250});this.download_button.on("click",function(){q.download_dialog.open()});settings_group=k(this.menu_svg).attr("transform","translate(5,5)");this.settings_button=h(this.menu_svg,180,4,30,30,settings_group);this.settings_button.on("click",function(){d.settings.open()});jsv_icon=this.menu_svg.append("text").attr({x:149,y:32,"font-family":"sans-serif",
"font-size":"16px","font-weight":"bold","stroke-width":1,fill:"grey","class":"jsv-button-text"}).style("text-anchor","middle").text("JSV")};var b=function(a,b,c,d){return setInterval(function(){a.translate_axis(b,c);a.fast_draw()},d)},c=function(a,b){return a.append("path").attr("d",p(b)).attr("stroke","black").attr("stroke-width",3).attr("fill","none")},a=function(a){a=a.append("g");a.append("line").attr("x1",3).attr("y1",8).attr("x2",13).attr("y2",8).attr("stroke-width",3).attr("stroke","black");
a.append("line").attr("x1",8).attr("y1",3).attr("x2",8).attr("y2",13).attr("stroke-width",3).attr("stroke","black");return a},g=function(a){return a.append("line").attr("x1",3).attr("y1",8).attr("x2",13).attr("y2",8).attr("stroke-width",3).attr("stroke","black")},f=function(a,b,c,d,e,g){a=a.append("g");var f=c+2,l=c+e-2,k=b+d/2;a.append("line").attr({x1:b,y1:c,x2:b+d,y2:c,"stroke-width":1});a.append("line").attr({x1:b,y1:c+e,x2:b+d,y2:c+e,"stroke-width":1});a.append("line").attr({x1:k,y1:f,x2:k,y2:l,
"stroke-width":1});a.append("line").attr({x1:k,y1:f,x2:k-2,y2:f+2,"stroke-width":1});a.append("line").attr({x1:k,y1:f,x2:k+2,y2:f+2,"stroke-width":1});a.append("line").attr({x1:k,y1:l,x2:k-2,y2:l-2,"stroke-width":1});a.append("line").attr({x1:k,y1:l,x2:k+2,y2:l-2,"stroke-width":1});a.attr("stroke","rgb(150, 150, 150)").attr("transform","rotate("+g+","+b+","+c+")");return a},k=function(a){a=a.append("g");a.append("circle").attr({cx:10,cy:10,r:7}).style("fill","rgb(75, 75, 75");a.append("line").attr({x1:10,
y1:1,x2:10,y2:19,"stroke-width":4});a.append("line").attr({x1:1,y1:10,x2:19,y2:10,"stroke-width":4});a.append("line").attr({x1:3.5,y1:3.5,x2:16.5,y2:16.5,"stroke-width":4});a.append("line").attr({x1:16.5,y1:3.5,x2:3.5,y2:16.5,"stroke-width":4});a.append("circle").attr({cx:10,cy:10,r:3}).style("fill","white");return a},l=function(a){a=a.append("g");a.append("line").attr({x1:10,y1:0,x2:10,y2:12,"stroke-linecap":"round","stroke-width":3});a.append("line").attr({x1:6,y1:7,x2:10,y2:12,"stroke-linecap":"round",
"stroke-width":3});a.append("line").attr({x1:14,y1:7,x2:10,y2:12,"stroke-linecap":"round","stroke-width":3});a.append("line").attr({x1:2,y1:16,x2:18,y2:16,"stroke-linecap":"round","stroke-width":3});return a},h=function(a,b,c,d,e,g){a=a.append("g").attr("class","jsv-menu-button");a.append("rect").attr({x:0,y:0,width:d,height:e,rx:2,ry:2}).style({"stroke-width":1});var f=g.remove();a.append("g").attr("class","jsv-button-image").append(function(){return f.node()});a.attr("transform","translate("+b+
".5,"+c+".5)");return a},p=d3.svg.line().x(function(a){return a.x}).y(function(a){return a.y}).interpolate("linear"),n=function(a,b){var c=a.sv_wrapper.select("#jsv-save-height").property("value"),d=a.sv_wrapper.select("#jsv-save-width").property("value"),e=a.image(d,c),g="JSV-Image-"+d+"x"+c,f=window.open(e,g);b.close();setTimeout(function(){f.document.title=g},100)};e.SVMenu=d})(JSpectraViewer);
(function(e){e.SVHelp=function(d){this.sv=d;this.dialog=new e.SVDialog(d,{header_text:"JSpectraViewer (JSV) Help",content_text:'The view of the spectra can be scrolled around or scaled using the controls in the menu or by using the various mouse and keyboard shortcuts:<h3>Viewer Controls</h3><table class="jsv-table"><thead><tr><th>Action</th><th>Command</th></tr></thead><tbody><tr><td>Zoom In/Out X Axis</td><td>Scroll wheel</td></tr><tr><td>Zoom In/Out Y Axis</td><td>Option/Alt Key + Scroll wheel</td></tr><tr><td>Zoom In on Area</td><td>Option/Alt Key + Click and Drag around area</td></tr><tr><td>Zoom Out Completely</td><td>Option/Alt Key + Click once anywhere on viewer </td></tr><tr><td>Move Around</td><td>Click and Drag</td></tr></tbody></table><h3>Zoombox Controls (box in upper left corner)</h3><table class="jsv-table"><thead><tr><th>Action</th><th>Command</th></tr></thead><tbody><tr><td>Move Around</td><td>Click and Drag grey selection box</td></tr><tr><td>Zoom In on Area</td><td>Click on unselected region and drag around new selection</td></tr><tr><td>Zoom Out Completely</td><td>Click once anywhere in unselected region</td></tr><tr><td>Alter Zoomed Area</td><td>Click and Drag on sides of grey selection box</td></tr></tbody></table><h3>Troubleshooting</h3><p>If the viewer is not showing any spectra or is slow, try updating to the latest version of your browser. We have found that <a href="https://www.google.com/chrome" target="_blank">Google Chrome</a> is the fastest.</p></div></div>',
width:700,height:350})}})(JSpectraViewer);
(function(e){function d(b,c){c=c||{};var a=this;this.wrapper=b.sv_wrapper.node();this.fade_time=e.default_for(c.fade_time,500);this.header_text=e.default_for(c.header_text,"");this.content_text=e.default_for(c.content_text,"");this.height=e.default_for(c.height,300);this.width=e.default_for(c.width,300);this.buttons=c.buttons;this.box=d3.select(this.wrapper).append("div").style("display","none").attr("class","jsv-dialog");this.header=this.box.append("div").attr("class","jsv-dialog-header").html(this.header_text);
this.dismiss=this.box.append("div").attr("class","jsv-dialog-dismiss").html("X").on("click",function(){a.close()});this.contents=this.box.append("div").attr("class","jsv-dialog-contents jsv-scroll");this.buttons&&(this.footer=this.box.append("div").attr("class","jsv-dialog-footer"),this.generate_buttons());this.contents.html(this.content_text);this.adjust_size();return a}d.prototype.visible=function(){return"none"!=this.box.style("display")};d.prototype.open=function(){this.adjust_size();this.box.style("display",
"block");this.box.transition().duration(this.fade_time).style("opacity",1);return this};d.prototype.close=function(){this.box.transition().duration(this.fade_time).style("opacity",0).each("end",function(){d3.select(this).style("display","none")});return this};d.prototype.generate_buttons=function(){var b=this;Object.keys(this.buttons).forEach(function(c){b.footer.append("button").html(c).attr("class","jsv-button").on("click",function(){b.buttons[c].call(b)})})};d.prototype.adjust_size=function(){var b=
this.wrapper.offsetWidth,c=this.wrapper.offsetHeight,a=this.width,d=this.height;this.height>c-50&&(d=c-50);this.width>b-50&&(a=b-50);b=d-40-(this.buttons?35:0);this.box.style("width",a+"px").style("height",d+"px");this.contents.style("height",b+"px")};e.SVDialog=d})(JSpectraViewer);
(function(e){function d(c,a){a=a||{};var d=this;this.sv=c;this.object=e.default_for(a.object,c);this.title=e.default_for(a.title,"Settings");this.height=e.default_for(a.height,400);this.width=e.default_for(a.width,400);a.settings=a.settings||[];this.settings=[];a.settings.forEach(function(a){d.settings.push(new b(d.object,a))});this.dialog=new e.SVDialog(c,{header_text:this.title,content_text:this.settings_html(),buttons:{Done:function(){this.close()}},width:this.width,height:this.height});return this}
function b(b,a){a=a||{};this.object=b;this.label=a.label;this.property=a.property;this.type=e.default_for(a.type,"boolean");this.id()}d.prototype.open=function(){var b=this;this.dialog.contents.html(this.settings_html());d3.selectAll(".jsv-setting").on("change",function(){var a=d3.select(this),d=b.find(a.attr("id")),a=a.property("checked");d.value(a);b.sv.full_draw()});this.dialog.open();return this};d.prototype.close=function(){this.dialog.close();return this};d.prototype.find=function(b){return this.settings.filter(function(a){return a.id()==
b})[0]};d.prototype.settings_html=function(){html='<div class="jsv-settings">';this.settings.forEach(function(b){html+='<div><label class="jsv-label">'+b.label+"</label>";html+='<div class="jsv-input-group">';if("boolean"==b.type){var a=html;html="";html+='<input type="checkbox" class="jsv-input jsv-setting" id="'+b.id()+'"';b.value()&&(html+=' checked="true" ');html+=" />";html=a+html}html+="</div></div>"});return html+="</div>"};setting_id=0;b.prototype.id=function(){var b="jsv-setting-id-"+setting_id++;
this.id=function(){return b};return b};b.prototype.value=function(b){0==arguments.length?b="function"===typeof this.property?this.property.call(this.object):this.object[this.property]:("function"===typeof this.property?this.property.call(this.object,b):this.object[this.property]=b,self.sv.full_draw());return b};e.SVSettings=d})(JSpectraViewer);
(function(e){function d(b){e.pixel(10);this.sv=b;var c=b.zoombox_size||10;this.width=b.width*c/100;this.height=b.height*c/100;this.svg=b.sv_wrapper.append("svg").attr("width",this.width+1).attr("height",this.height+1).style("position","absolute").style("top",0).style("left",b.width-this.width-1);b.axis_x_reverse&&this.svg.style("left",0);this.border=this.svg.append("rect").attr("x",0).attr("y",0).attr("width",this.width).attr("height",this.height).attr("fill","white").attr("stroke","#BBB");this.scale=
new e.SVScale;this.scale.y.range([this.height,0]);this.scale.x.range(this.sv.axis_x_reverse?[this.width,0]:[0,this.width]);this.initialize_brushing();this.spectra_function=d3.svg.line().x(function(a){return this.scale.x(a.x)}).y(function(a){return this.scale.y(a.y)}).interpolate("linear")}Object.defineProperty(d.prototype,"visible",{get:function(){return this._visible},set:function(b){(this._visible=b)?this.svg.style("display","block"):this.svg.style("display","none");this.sv.legend.update();this.sv.draw()}});
d.prototype.initialize_brushing=function(){var b=this,c=b.sv;b.brush=d3.svg.brush().x(b.scale.x).y(b.scale.y).on("brushstart",function(){d3.event.sourceEvent.preventDefault()}).on("brush",function(){if(!b.brush.empty()){if(!1!==c.axis_y_lock){var a=b.brush.extent(),d=a[0][0],a=a[1][0],f=b.scale.y.domain()[0],k=b.scale.y.invert(d3.mouse(b.svg.node())[1]),l=b.scale.y.domain()[1],k=Math.min(k,l),k=Math.max(f,k);b.brush.extent([[d,f],[a,k]]);b.svg.selectAll(".zoom-brush").call(b.brush)}c.set_domain_to_brush_extent(b.brush.extent(),
!1);c.fast_draw();c.debug&&(c.debug_data.zbox.X1=e.round(b.brush.extent()[0][0]),c.debug_data.zbox.Y1=e.round(b.brush.extent()[0][1]),c.debug_data.zbox.X2=e.round(b.brush.extent()[1][0]),c.debug_data.zbox.Y2=e.round(b.brush.extent()[1][1]))}}).on("brushend",function(){b.brush.empty()&&(b.set_zoom_area(c.boundary),c.zoom_out_completely());c.zoom_axis="";c.draw()});b.select_brush=b.svg.append("g").attr("class","active-brush").call(b.brush)};d.prototype.add_spectrum=function(b){var c=this.sv.boundary;
this.scale.x.domain(c.x.domain());this.scale.y.domain(c.y.domain());this.svg.append("path").attr("id",b.id).attr("d",this.spectra_function(b.simple_xy_data.asArray())).attr("stroke",b.color).attr("stroke-width",.5).attr("fill","none");this.set_zoom_area(c)};d.prototype.remove_spectra=function(b){this.sv.container.select("path#"+b).remove()};d.prototype.update=function(){var b=this,c=this.sv;c.axis_x_reverse?this.svg.style("left",0):this.svg.style("left",c.width-this.width-1);this.sv.all_spectra().forEach(function(a){b.remove_spectra(a.id);
a.active&&b.add_spectrum(a)})};d.prototype.set_zoom_area=function(b){var c=b.x.domain()[0],a=b.x.domain()[1],d=b.y.domain()[0];b=b.y.domain()[1];this.brush.extent([[c,d],[a,b]]);this.svg.selectAll(".active-brush").call(this.brush)};e.ZoomBox=d})(JSpectraViewer);
(function(e){e.default_for=function(d,b){return void 0===d?b:d};e.pixel_ratio=1;e.pixel=function(d){return d*e.pixel_ratio};e.get_pixel_ratio=function(d){d=d.getContext("2d");return(window.devicePixelRatio||1)/(d.webkitBackingStorePixelRatio||d.mozBackingStorePixelRatio||d.msBackingStorePixelRatio||d.oBackingStorePixelRatio||d.backingStorePixelRatio||1)};e.scale_resolution=function(d,b){d.getContext("2d");if(1!=b){var c=d.width,a=d.height;d.width=c*b;d.height=a*b;d.style.width=c+"px";d.style.height=
a+"px"}};Function.prototype.inherits=function(d){this.prototype=Object.create(d.prototype)};e.merge=function(){for(var d={},b,c,a,e=0,f=arguments.length;e<f;e++)if(b=arguments[e],"object"===typeof b){c=Object.keys(b);for(var k=0,l=c.length;k<l;k++)a=c[k],d[a]=b[a]}return d};e.unique_id=function(d,b,c){var a;do a=d+b,b++;while(-1<c.indexOf(a));return a};e.round=function(d,b){return d3.round(d,b||2)};e.elapsed_time=function(d){return(new Date).getTime()-d+" ms"};e.index_of_value=function(d,b,c){var a=
0,e=d.length-1,f,k;if(d[a]>=b)return a;if(d[e]<=b)return e;for(;1<e-a;)if(f=(a+e)/2|0,k=d[f],k<b)a=f;else if(k>b)e=f;else return f;return c?e:a};e.lorentzian=function(d,b,c,a){c*=c;d-=b;return a*c/(c+4*d*d)};e.sum_of_peaks=function(d,b){for(var c=0,a,g=0;g<b.length;g++)a=b[g],c+=e.lorentzian(d,a.center,a.width,a.amplitude);return c};e.xy_from_peaks=function(d,b,c,a,g){g&&(d=e.peaks_in_range(d,c,a,6));g=e.peaks_in_range(d,c,a).order_by("center").map(function(a){return a.center});var f=c,k=[],l=[];
for(b=(a-c)/b;f<a;)k.push(f),l.push(e.sum_of_peaks(f,d)),f=g[0]&&g[0]<=f+b?g.shift():f+b;k.push(a);l.push(e.sum_of_peaks(a,d));return{x:k,y:l}};e.peaks_in_range=function(d,b,c,a){a=a||0;var g=new e.SVSet;d.forEach(function(d){e.peak_min([d],a)<c&&e.peak_max([d],a)>b&&g.push(d)});return g};e.peak_min=function(d,b){b=b||3;var c,a;0<d.length&&(a=d[0]);d.forEach(function(b){b.center<a.center&&(a=b)});a&&(c=a.center-b*a.width);return c};e.peak_max=function(d,b){b=b||3;var c,a;0<d.length&&(a=d[0]);d.forEach(function(b){b.center>
a.center&&(a=b)});a&&(c=a.center+b*a.width);return c};e.number=function(d){if(void 0!==d)return Number(d)};e.isNumeric=function(d){return isFinite(d)&&parseFloat(d)==d};e.decimalPlaces=function(d){return(d=(""+d).match(/(?:\.(\d+))?(?:[eE]([+-]?\d+))?$/))?Math.max(0,(d[1]?d[1].length:0)-(d[2]?+d[2]:0)):0};e.colors=function(d,b,c,a,e,f,k,l,h,p){var n=[];void 0==d&&(d=50);void 0==b&&(b=200);void 0==c&&(c=30);void 0==a&&(a=1);void 0==e&&(e=2.4);void 0==f&&(f=2.4);void 0==k&&(k=2.4);void 0==l&&(l=0);
void 0==h&&(h=2);void 0==p&&(p=4);for(var m=0;m<d;++m)n.push("rgba("+Math.round(Math.sin(e*m+l)*c+b)+","+Math.round(Math.sin(f*m+h)*c+b)+","+Math.round(Math.sin(k*m+p)*c+b)+","+a+")");return n};e.test_colors=function(d){d.forEach(function(b){document.write('<font style="color:'+b+'">&#9608;</font>')});document.write("<br/>")};e.convert_base64_to_float64=function(d,b){"undefined"===typeof b&&(b=!1);var c=atob(d),a=new Int8Array(c.length);b&&(a=new Zlib.Deflate(a));for(var e=0;e<c.length;e++)a[e]=c.charCodeAt(e);
return new Float64Array(a.buffer)};e.convert_bayesil_data=function(d){var b={id:e.default_for(d.id,"Fit"),name:e.default_for(d.name,"Fit"),compounds:[],display:e.merge({color:"blue"},d.display),meta:{dss_concentration:d.dss_conc}};d.metabolites.forEach(function(c){var a={concentration:c.concentration,concentration_units:"\u03bcM",id:c.id,name:c.name,clusters:[],display:{visible:!1},meta:{dss_ratio:e.default_for(e.number(c.dss_ratio),1),threshold:c.threshold,score:c.score}};a.meta.amplitude_coefficient=
a.concentration/a.meta.dss_ratio/b.meta.dss_concentration;c.clusters.forEach(function(b){var c={peaks:[],meta:{shift:b.shift}};b.shift=e.default_for(b.shift,0);c.upper_bound=b.upper_bound;c.lower_bound=b.lower_bound;c.meta.lower_bound_diff=b.lower_bound_diff;c.meta.upper_bound_diff=b.upper_bound_diff;b.peaks.forEach(function(d){c.peaks.push({center:Number(d.center)+Number(b.shift),width:Number(d.width),amplitude:Number(d.amplitude)*Number(a.meta.amplitude_coefficient),meta:{initial_width:d.initial_width}})});
a.clusters.push(c)});b.compounds.push(a)});return b};e.create_bayesil_json=function(d,b){d=d||{xy_data:{x:[],y:[]}};var c={dss_conc:b.meta.dss_concentration,metabolites:[],meta:d.meta};b.compounds().forEach(function(a){var d={name:a.name,id:a.id,concentration:a.concentration,dss_ratio:a.meta.dss_ratio,score:a.meta.score,threshold:a.meta.threshold,clusters:[]};a.meta.amplitude_coefficient=a.concentration/a.meta.dss_ratio/b.meta.dss_concentration;a.clusters().forEach(function(b){var c={center:b.center(),
initial_center:b.meta.initial_center,shift:b.center(),lower_bound:b.lower_bound,upper_bound:b.upper_bound,peaks:[]};b.peaks().forEach(function(d){d={amplitude:d.amplitude/a.meta.amplitude_coefficient,center:d.center-b.center(),width:d.width,initial_width:d.meta.initial_width};isNaN(d.amplitude)&&(d.amplitude=0);c.peaks.push(d)});d.clusters.push(c)});c.metabolites.push(d)});c.spectrum_xy={x:d.xy_data.x,y:d.xy_data.y};return c};Number.isInteger||(Number.isInteger=function(d){return"number"===typeof d&&
isFinite(d)&&-9007199254740992<d&&9007199254740992>d&&Math.floor(d)===d})})(JSpectraViewer);
(function(e){var d=[];e.simplify=function(b,c,a){var e=b.x.length;if(1>=e)return b;d=b;var f=Array(e);for(b=0;b<e;b++)f[b]=b;b=void 0!==c?c*c:1;var k;if(a)k=f;else{a=f[0];c=[a];for(var e=1,l=f.length;e<l;e++){k=f[e];var h=d.x[k]-d.x[a],p=d.y[k]-d.y[a];h*h+p*p>b&&(c.push(k),a=k)}a!==k&&c.push(k);k=c}f=k.length;a=new ("undefined"!==typeof Uint8Array?Uint8Array:Array)(f);c=0;var e=f-1,l=[],h=[],n,m,q;for(a[c]=a[e]=1;e;){n=0;for(p=c+1;p<e;p++){m=k[p];var u=k[c],t=k[e],r=d.x[u],u=d.y[u],w=d.x[t]-r,v=d.y[t]-
u;if(0!==w||0!==v){var x=((d.x[m]-r)*w+(d.y[m]-u)*v)/(w*w+v*v);1<x?(r=d.x[t],u=d.y[t]):0<x&&(r+=w*x,u+=v*x)}w=d.x[m]-r;v=d.y[m]-u;m=w*w+v*v;m>n&&(q=p,n=m)}n>b&&(a[q]=1,l.push(c,q,q,e));e=l.pop();c=l.pop()}for(p=0;p<f;p++)a[p]&&h.push(k[p]);f=h;q=Array(f.length);k=Array(f.length);b=0;for(a=f.length;b<a;b++)q[b]=d.x[f[b]],k[b]=d.y[f[b]];var y;if(d.yi)for(y=Array(f.length),b=0,a=f.length;b<a;b++)y[b]=d.yi[f[b]];b={x:q,y:k};y&&(b.yi=y);return b}})(JSpectraViewer);
(function(e){function d(a){this.container_id=a.container_id;this.width=a.width||200;this.height=a.height||200;this.container=d3.select(this.container_id);this.container.classed("js-structure",!0);this.data=a.data;this.format=a.format||"mol";this.x_scale;this.y_scale;this.avgL=0;this.show_hydrogen=e.default_for(a.show_hydrogen,!1);this.show_atom_numbers=e.default_for(a.show_atom_numbers,!1);this.nmr_nucleus=a.nmr_nucleus;this.interactive_1H=!0;this._atoms=new e.SVSet;this._bonds=new e.SVSet;this.data&&
this.read_data(this.data,this.format);this.handlers=new e.SVEvents;this.on=this.handlers.on;this.off=this.handlers.off;this.trigger=this.handlers.trigger}function b(a){a=a||{};this.x=e.default_for(a.x,0);this.y=e.default_for(a.y,0);this.id=a.id;this.symbol=e.default_for(a.symbol,0);this.index=e.default_for(a.index,0);this.number=e.default_for(a.number,1);this.mass=e.default_for(a.mass,0);this.charge=e.default_for(a.charge,0);this._bonds=new e.SVSet;this._bonded_Hs=new e.SVSet;this._bonded_atoms=new e.SVSet}
function c(a){a=a||{};this.a1=a.a1;this.a2=a.a2;this.order=e.default_for(a.order,1);this.stereo=e.default_for(a.stereo,0);this._atoms=new e.SVSet([this.a1,this.a2])}d.prototype.nmr_1H=function(){return this.nmr_nucleus&&"1H"==this.nmr_nucleus.toUpperCase()};d.prototype.nmr_13C=function(){return this.nmr_nucleus&&"13C"==this.nmr_nucleus.toUpperCase()};d.prototype.initSVG=function(){var a=this.container,b=d3.extent(this.atoms(),function(a){return a.x}),c=d3.extent(this.atoms(),function(a){return a.y}),
d=[15,15,20,15];this.margins=d;var e=this.width-d[1]-d[3],h=this.height-d[0]-d[2];this.structure_ratio=(b[1]-b[0])/(c[1]-c[0]);"height"==(e/h>=this.structure_ratio?"height":"width")?e=h*this.structure_ratio:h=e/this.structure_ratio;this.wp=e;this.hp=h;this.x_scale=d3.scale.linear().domain([b[0],b[1]]).range([d[1],e-d[3]]);this.y_scale=d3.scale.linear().domain([c[0],c[1]]).range([h-d[2],d[0]]);a.style({height:this.height+"px",width:this.width+"px"});this.add_menu_bar();this.add_resizer();a.select("div.js-graph-div").remove();
this.graph_div=a.append("div").attr("class","js-graph-div").style({width:e+"px",height:h+"px",margin:"0 auto","margin-top":(this.height-h-d[0])/2+"px"});return this.graph_div.append("svg:svg").attr("width","100%").attr("height","100%").append("svg:g")};d.prototype.add_menu_bar=function(){var a=this;a.container.select("div.menubar").remove();var b=a.container.append("div").attr("class","menubar");a.button_toggle_H=b.append("div").attr("class","toggle-hydrogens menu-button button-on").text("H").on("click",
function(){a.toggleH();d3.event.stopPropagation()});a.button_toggle_numbers=b.append("div").attr("class","toggle-atom-ids menu-button button-on").text("#").on("click",function(){a.toggleAtomNumbers();d3.event.stopPropagation()});a.menu_buttons_width=a.button_toggle_numbers.node().offsetWidth+a.button_toggle_numbers.node().offsetWidth+2;a.menu_title=b.append("div").attr("class","structure-title").style("width",a.width-a.menu_buttons_width+"px").text(a.title)};d.prototype.add_resizer=function(){var a=
this,b=a.margins,d=a.wp,c=a.hp,e=d3.select("body");a.resizer=a.container.append("div").attr("class","js-structure-resizer").on("mousedown.resizer",function(){var h=d3.event.x,n=d3.event.y;d3.event.preventDefault();e.on("mousemove.resizer",function(){dx_mouse=d3.event.x-h;dy_mouse=d3.event.y-n;h=d3.event.x;n=d3.event.y;a.height+=dy_mouse;a.width+=dx_mouse;a.container.style({height:a.height+"px",width:a.width+"px"});var e;e="height"==(a.width/a.height>=a.structure_ratio?"height":"width")?(a.height-
b[0]-b[2])/c:(a.width-b[1]-b[3])/d;a.graph.attr("transform","scale("+e+","+e+")");a.graph_div.style({width:d*e+"px",height:c*e+"px","margin-top":(a.height-c*e-b[0])/2+"px"});a.menu_title.style("width",a.width-a.menu_buttons_width+"px");a.trigger("structure-resize")});e.on("mouseup.resizer",function(){e.on("mousemove.resizer",null);e.on("mouseup.resizer",null)})}).on("click.resizer",function(){d3.event.stopPropagation()});var h=d3.svg.line().x(function(a){return a.x}).y(function(a){return a.y}).interpolate("linear");
a.resizer.append("svg").style({width:"100%",height:"100%"}).append("path").attr("d",h([{x:9,y:4},{x:4,y:4},{x:4,y:9},{x:4,y:4},{x:16,y:16},{x:16,y:11},{x:16,y:16},{x:11,y:16}])).attr("stroke","grey").attr("stroke-width",1).attr("stroke-linejoin","round").attr("stroke-linecap","round").attr("fill","none")};d.prototype.drawBonds=function(){var a=this,b=this.graph,c=this.x_scale,d=this.y_scale;this.create_bond_functions();this.bonds().forEach(function(e){var h=e.a1,p=e.a2,n,m=p.x-h.x,q=p.y-h.y,u=Math.sqrt(m*
m+q*q),t=m/u*.2,r=q/u*.2,q=h.x+t,m=h.y+r,t=p.x-t,r=p.y-r,w=a.avgL,v=c(q),x=d(m),y=c(t),z=d(r);a.avgL=w+Math.sqrt((y-v)*(y-v)+(z-x)*(z-x));w=[];if(1===e.order)if(1===e.stereo)u=Math.sqrt((t-q)*(t-q)+(r-m)*(r-m)),n=.1,e=n*(r-m)/u,v=n*(q-t)/u,w=[[q,m],[t+e,r+v],[t-e,r-v]],n=b.append("svg:path").style("fill","black").style("stroke-width",1).attr("d",a.wedgeBond(w));else if(6===e.stereo){n=.2;e=n*(r-m)/u;v=n*(q-t)/u;u=t+e-q;n=r+v-m;t=t-e-q;r=r-v-m;for(e=.05;1>=e;e+=.15)w.push([q+u*e,m+n*e],[q+t*e,m+r*
e]);n=b.append("svg:path").style("fill","none").style("stroke-width",1).attr("d",a.hashBond(w)).attr("stroke","black")}else if(4===e.stereo){n=.2;e=n*(r-m)/u;v=n*(q-t)/u;u=t+e-q;n=r+v-m;t=t-e-q;r=r-v-m;for(e=.05;1>=e;e+=.1)0===w.length%2?w.push([q+u*e,m+n*e]):w.push([q+t*e,m+r*e]);n=b.append("svg:path").attr("d",a.wigglyBond(w)).attr("fill","none").style("stroke-width",1).attr("stroke","black")}else w=[[q,m],[t,r]],n=b.append("svg:path").attr("d",a.plainBond(w)).attr("stroke-width","1").attr("stroke-linecap",
"round").attr("stroke-linejoin","round").attr("stroke","black");else 2===e.order?(n=.1,e=n*(r-m)/u,v=n*(q-t)/u,w=[[q+e,m+v],[t+e,r+v],[q-e,m-v],[t-e,r-v]],n=b.append("svg:path").attr("d",a.plainBond(w)).attr("stroke-width","1").style("fill","none").attr("stroke-linecap","round").attr("stroke-linejoin","round").attr("stroke","black")):3===e.order&&(n=.15,e=n*(r-m)/u,v=n*(q-t)/u,w=[[q,m],[t,r],[q+e,m+v],[t+e,r+v],[q-e,m-v],[t-e,r-v]],n=b.append("svg:path").attr("d",a.plainBond(w)).attr("stroke-width",
"1").attr("stroke-linecap","round").attr("stroke-linejoin","round").attr("stroke","black"));(h.is("H")||p.is("H"))&&n.classed("bond-H",!0)});a.avgL/=this.bonds().length};d.prototype.drawAtoms=function(){var a=this.graph,b=this.avgL,c=this.x_scale,d=this.y_scale;this.atoms().forEach(function(e){var h=a.append("svg:g").attr("transform","translate("+c(e.x)+","+d(e.y)+")");h.attr("class","atom");(e.is("C")||e.is("N"))&&0<e.bonded_Hs().length&&h.classed("nmr-1h",!0);e.is("C")&&h.classed("nmr-13c",!0);
e.is("H")&&(h.classed("atom-H",!0),(e.isBondedTo("C")||e.isBondedTo("N"))&&h.classed("nmr-1h",!0));h.attr("data-atom-number",e.number);h.attr("data-atom-id",e.id);h.append("svg:circle").attr("r",Math.ceil(b/3)).attr("fill","white").attr("opacity","1");h.append("svg:circle").attr("r",Math.ceil(b/2)).attr("fill-opacity","0").attr("class","overlay");h.append("text").attr("dy",Math.ceil(b/4.5)).attr("text-anchor","middle").attr("font-family","sans-serif").attr("font-size",Math.ceil(b/1.5)).attr("fill",
e.color()).text(e.symbol);h.append("text").attr("dy",Math.ceil(b/2)+2).attr("text-anchor","middle").attr("font-family","sans-serif").attr("font-size",Math.ceil(b/2.5)).attr("stroke","#FFF").attr("stroke-width","2px").attr("fill","#595").attr("paint-order","stroke").classed("atom-id",!0).text(e.display_id);if(0!==e.charge){var p=e.charge,p=0>p?-1===p?"-":p+"-":1===p?"+":p+"+";h.append("text").attr("dx",1*Math.ceil(b/3)).attr("dy",-1*Math.ceil(b/4.5)).attr("text-anchor","left").attr("font-family","sans-serif").attr("fill",
e.color()).attr("font-size",Math.ceil(b/3)).text(p)}0!==e.mass&&h.append("text").attr("dx",-2*Math.ceil(b/3)).attr("dy",-1*Math.ceil(b/4.5)).attr("text-anchor","left").attr("font-family","sans-serif").attr("font-size",Math.ceil(b/3)).attr("fill",e.color()).text(e.mass)})};d.prototype.create_bond_functions=function(){var a=this.x_scale,b=this.y_scale;this.plainBond=d3.svg.line().interpolate(function(a){for(var b=a[0][0]+","+a[0][1],c=1;c<a.length;c++)b=0===c%2?b+("M"+a[c][0]+","+a[c][1]):b+("L"+a[c][0]+
","+a[c][1]);return b}).x(function(b){return a(b[0])}).y(function(a){return b(a[1])});this.wedgeBond=d3.svg.line().x(function(b){return a(b[0])}).y(function(a){return b(a[1])});this.hashBond=d3.svg.line().interpolate(function(a){for(var b=a[0][0]+","+a[0][1],c=1;c<a.length;c++)b=0===c%2?b+("M"+a[c][0]+","+a[c][1]):b+("L"+a[c][0]+","+a[c][1]);return b}).x(function(b){return a(b[0])}).y(function(a){return b(a[1])});this.wigglyBond=d3.svg.line().interpolate("cardinal").x(function(b){return a(b[0])}).y(function(a){return b(a[1])})};
AtomColors={H:"#000000",He:"#FFC0CB",Li:"#B22222",B:"#00FF00",C:"#000000",N:"#8F8FFF",O:"#F00000",F:"#DAA520",Na:"#0000FF",Mg:"#228B22",Al:"#808090",Si:"#DAA520",P:"#FFA500",S:"#FFC832",Cl:"#00FF00",Ca:"#808090",Ti:"#808090",Cr:"#808090",Mn:"#808090",Fe:"#FFA500",Ni:"#A52A2A",Cu:"#A52A2A",Zn:"#A52A2A",Br:"#A52A2A",Ag:"#808090",I:"#A020F0",Ba:"#FFA500",Au:"#DAA520"};Object.defineProperties(d.prototype,{selected_atoms:{get:function(){var a=this,b=new e.SVSet;this.container.selectAll(".atom.selected").each(function(){var c=
d3.select(this).attr("data-atom-id");b.push(a.atoms(c))});return b},set:function(a){var b=this.container;b.selectAll(".atom").classed("selected",!1);a.forEach(function(a){b.select('.atom[data-atom-id="'+a.id+'"]').classed("selected",!0)});this.add_partially_selected_highlighting(a)}}});d.prototype.add_partially_selected_highlighting=function(a){var b=this.container;b.selectAll(".atom").classed("selected-partially",!1);if(this.nmr_1H()){var c=this.hydrogens_from_atoms(a);a=c.map(function(a){return a.bonded_atoms(1)});
a=(new e.SVSet(a)).unique();a.forEach(function(a){var d=!0;a.bonded_Hs().forEach(function(a){c.contains(a)||(d=!1)});d||b.select('.atom[data-atom-id="'+a.id+'"]').classed("selected-partially",!0)})}};d.prototype.read_data=function(a,b){"mol"==b?this.read_mol(a):"nmrml"==b?this.read_nmrml(a):console.log("Format not recognized: "+b+". Must be one of the following: nmrml, mol")};d.prototype.read_nmrml=function(a){var d=this;if(window.X2JS){var f=(new X2JS).xml_str2json(a);this.data=a;this._atoms=new e.SVSet;
this._bonds=new e.SVSet;f.structure&&f.structure.atomList&&f.structure.atomList.atom&&Array.isArray(f.structure.atomList.atom)?f.structure&&f.structure.bondList&&f.structure.bondList.bond&&Array.isArray(f.structure.bondList.bond)?(f.structure.atomList.atom.forEach(function(a,c){var e=new b({id:a._id,x:parseFloat(a._x),y:parseFloat(a._y),symbol:a._elementType,number:c+1});d._atoms.push(e)}),f.structure.bondList.bond.forEach(function(a){var b=a._atomRefs.split(/\s+/),e=d.atoms(b[0]),b=d.atoms(b[1]);
a=new c({a1:e,a2:b,order:parseInt(a._order)});d._bonds.push(a);e._bonds.push(a);b._bonds.push(a);e._bonded_atoms.push(b);b._bonded_atoms.push(e)}),d.addAtomDisplayIDs(),d.draw()):console.log("nmrML not formatted correctly: no bonds found"):console.log("nmrML not formatted correctly: no atoms found")}else console.log("X2JS needs to be installed to read nmrML: https://github.com/abdmob/x2js")};d.prototype.read_mol=function(a){var d=a.split(/\r\n|\n/),f=d[3].match(/\d+/g),k=parseFloat(f[0]),f=parseFloat(f[1]);
this.title=d[1];this.data=a;this._atoms=new e.SVSet;this._bonds=new e.SVSet;for(a=4;a<k+4;a++){var l=d[a].match(/-*\d+\.\d+|\w+/g),l=new b({x:parseFloat(l[0]),y:parseFloat(l[1]),symbol:l[3],number:a-4+1,mass:0,charge:0});l.id="a"+l.number;this._atoms.push(l)}for(a=k+4;a<k+f+4;a++){var l=d[a].match(/\d+/g),h=this.atoms(parseInt(l[0])),p=this.atoms(parseInt(l[1])),l=new c({a1:h,a2:p,order:parseInt(l[2]),stereo:parseInt(l[3])});this._bonds.push(l);h._bonds.push(l);p._bonds.push(l);h._bonded_atoms.push(p);
p._bonded_atoms.push(h)}for(k=k+f+4;k<d.length;k++)if(-1!==d[k].indexOf("M  ISO"))for(f=d[k].match(/-*\d+/g),a=0,l=1;a<f[0];a++,l+=2)this.atoms(f[l]).mass=parseInt(f[l+1],10);else if(-1!==d[k].indexOf("M  CHG"))for(f=d[k].match(/-*\d+/g),a=0,l=1;a<f[0];a++,l+=2)atoms[f[l]-1].charge=parseInt(f[l+1],10),this.atoms(f[l]).charge=parseInt(f[l+1],10);this.addAtomDisplayIDs();this.draw()};d.prototype.draw=function(){this.graph=this.initSVG();this.avgL=0;this.drawBonds();this.drawAtoms();this.addInteractivity();
this.toggleH(this.show_hydrogen);this.toggleAtomNumbers(this.show_atom_numbers)};d.prototype.atoms=function(a){return this._atoms.get(a)};d.prototype.bonds=function(a){return this._bonds.get(a)};d.prototype.addInteractivity=function(){var a=this,b=this.container;b.on("mouseenter",function(){b.selectAll(".atom").style("cursor","default");a.nmr_1H()?b.selectAll(".atom.nmr-1h").classed("highlight",!0).style("cursor","pointer"):a.nmr_13C()&&b.selectAll(".atom.nmr-13c").classed("highlight",!0).style("cursor",
"pointer")});b.on("mouseleave",function(){b.selectAll(".atom").classed("highlight",!1)});b.selectAll(".atom").on("click",function(){var b=d3.select(this).attr("data-atom-id");b&&(b=a.atoms(b),a.nmr_1H()?a.select_clicked_atoms_for_1H_nmr(b,d3.event.shiftKey):a.nmr_13C()&&a.select_clicked_atoms_for_13C_nmr(b,d3.event.shiftKey));a.trigger("structure-click");d3.event.stopPropagation()});b.on("click",function(){a.selected_atoms=[];a.trigger("structure-click")})};d.prototype.select_clicked_atoms_for_1H_nmr=
function(a,b){var c=this.selected_atoms;if(b)if(window.getSelection().removeAllRanges(),c.contains(a))if(a.is("H"))var d=a.bonded_atoms(1),c=c.remove(d).remove(a);else a.bonded_Hs().forEach(function(a){c=c.remove(a)}),c=c.remove(a);else c.push(a);else c=new e.SVSet(a);this.selected_atoms=c};d.prototype.select_clicked_atoms_for_13C_nmr=function(a,b){var c=this.selected_atoms;b?(window.getSelection().removeAllRanges(),c.contains(a)?c=c.remove(a):c.push(a)):c=new e.SVSet(a);this.selected_atoms=c};d.prototype.toggleH=
function(a){(this.show_hydrogen=void 0===a?!this.show_hydrogen:a)?(d3.selectAll(".atom-H, .bond-H").style("display","inline"),this.button_toggle_H.classed("button-on",!0)):(d3.selectAll(".atom-H, .bond-H").style("display","none"),this.button_toggle_H.classed("button-on",!1))};d.prototype.toggleAtomNumbers=function(a){(this.show_atom_numbers=void 0===a?!this.show_atom_numbers:a)?(d3.selectAll(".atom-id").style("display","inline"),this.button_toggle_numbers.classed("button-on",!0)):(d3.selectAll(".atom-id").style("display",
"none"),this.button_toggle_numbers.classed("button-on",!1))};d.prototype.addAtomDisplayIDs=function(){var a=new e.SVSet(this.atoms().filter(function(a){return!a.is("H")}));a.each(function(){this.morgan_num=1});for(var b=new e.SVSet,c=-1;c!=b.unique().length;)c=b.unique().length,b=new e.SVSet,a.forEach(function(a){var b=0;a.bonded_atoms().each(function(){this.is("H")||(b+=this.morgan_num)});a.morgan_temp=b}),a.forEach(function(a){a.morgan_num=a.morgan_temp;b.push(a.morgan_num)});a.order_by("morgan_num",
!0);for(var d=a[0],c=1;d;)d.display_id=c,d=d.bonded_atoms().filter(function(a){return!a.is("H")&&void 0==a.display_id}),d=new e.SVSet(d),d=0<d.length?d.order_by("morgan_num",!0)[0]:a.find(function(a){return void 0==a.display_id}),c+=1;this.addHydrogenDisplayIDs()};d.prototype.addHydrogenDisplayIDs=function(){var a=["a","b","c","d"];this.atoms().forEach(function(b){b.is("H")||b.bonded_Hs().forEach(function(c,d){c.display_id=b.display_id+a[d]})})};d.prototype.hydrogens_from_atoms=function(a){var b=
new e.SVSet;a.forEach(function(a){a.is("H")?b.push(a):b.merge(a.bonded_Hs())});return b.unique()};d.prototype.nmr_atoms_from_atoms=function(a){if(this.nmr_1H())return this.hydrogens_from_atoms(a);if(this.nmr_13C())return(new e.SVSet(a.filter(function(a){return a.is("C")}))).unique()};d.prototype.LCA_from_hydrogens=function(a){var b=new e.SVSet;if(!a||a.empty())return b;var c=this.hydrogens_from_atoms(a);a=c.map(function(a){return a.bonded_atoms(1)});a=(new e.SVSet(a)).unique();a.forEach(function(a){var d=
!0,h=new e.SVSet;a.bonded_Hs().forEach(function(a){c.contains(a)?h.push(a):d=!1});d?b.push(a):b.merge(h)});return b.unique()};d.prototype.LCA_from_nmr_atoms=function(a){if(this.nmr_1H())return this.LCA_from_hydrogens(a);if(this.nmr_13C())return(new e.SVSet(a.filter(function(a){return a.is("C")}))).unique()};d.prototype.LCA_and_hydrogens=function(a){var b=this.hydrogens_from_atoms(a);a=this.LCA_from_hydrogens(a);return b.merge(a).unique()};d.prototype.LCA_and_nmr_atoms=function(a){if(this.nmr_1H())return this.LCA_and_hydrogens(a);
if(this.nmr_13C())return(new e.SVSet(a.filter(function(a){return a.is("C")}))).unique()};b.prototype.toString=function(){return"Atom"};b.prototype.bonds=function(a){return this._bonds.get(a)};b.prototype.bonded_atoms=function(a){return this._bonded_atoms.get(a)};b.prototype.bonded_Hs=function(a){a=this.bonded_atoms().filter(function(a){return a.is("H")});return new e.SVSet(a)};b.prototype.is=function(a){return this.symbol==a};b.prototype.isBondedTo=function(a){return this.bonded_atoms().some(function(b){return b.symbol==
a})};b.prototype.color=function(){return d3.rgb(AtomColors[this.symbol])};c.prototype.toString=function(){return"Bond"};c.prototype.atoms=function(a){return this._atoms.get(a)};e.SVStructure=d})(JSpectraViewer);
(function(e){function d(b,c){c=c||{};this.sv=b;this.struct=b.structure;this.container_id=c.container_id;this.container=d3.select(this.container_id);this.table=this.container.append("table").classed("jsv-assignment-table",!0);this.nmr_nucleus=e.default_for(c.nmr_nucleus,"1H");window.Sortable||(console.log("Sortable needs to be installed to make peaks/atoms dragable: https://github.com/RubaXa/Sortable"),this.sortable=!1);this.add_sv_events();this.struct&&this.add_struct_events();this.edit_mode=c.edit_mode}
d.prototype.nmr_1H=function(){return this.nmr_nucleus&&"1H"==this.nmr_nucleus.toUpperCase()};d.prototype.nmr_13C=function(){return this.nmr_nucleus&&"13C"==this.nmr_nucleus.toUpperCase()};d.prototype.get_columns=function(){var b=this.struct,c=d3.format(".2f"),a=function(a,c){html="";a&&0<a.length?html=b.LCA_from_nmr_atoms(a).map(function(a){return"<div class='jsv-badge atom-badge' data-atom-id='"+a.id+"'>"+a.display_id+"</div>"}).join(""):c&&0<c.length&&(html=c.map(function(a){return"<div class='jsv-badge atom-badge' data-atom-id=''>"+
a+"</div>"}).join(""));return html},d=function(a){return a.reverse().map(function(a){return"<span class='jsv-badge peak-badge' data-peak-id='"+a.path_id()+"'>"+c(a.center)+"</span>"}).join("")},e=[{heading:"No.",class:"cluster-number center",html:function(a){return a.number}},{heading:"Center",class:"center",html:function(a){return c(a.center)}},{heading:"Peaks",class:"center",html:function(a){return a.peak_num}},{heading:"Type",class:"center",html:function(a){return a.multiplet_type}},{heading:"H's",
class:"center",html:function(a){return a.atoms.length}},{heading:"Atoms",class:"atom-cell",html:function(b){return a(b.atoms,b.atom_refs)}},{heading:"",class:"add-atom-cell",html:function(a,b){return"<div class='add-atoms-container'><a class='add-atoms jsv-btn' href='javascript:void(0)'>+</a><div>"}},{heading:"Peak Centers",class:"peak-cell",html:function(a){return d(a.peaks)}}];this.nmr_13C()&&(e[4].heading="C's");b||e.splice(4,3);return e};d.prototype.update_table_header=function(){this.table.select("thead").remove();
this.table.append("thead").append("tr").selectAll("th").data(this.columns).enter().append("th").attr("class",function(b){return b.class}).text(function(b){return b.heading})};d.prototype.update_table=function(){var b=this.struct,c=this.table,a=this.columns;rows=[];this.sv._cluster_navigation.static_compounds=this.sv.compounds();this.sv.clusters().each(function(a){row={path_id:this.path_id(),number:a+1,center:this.center(),peak_num:this.peaks().length,peaks:this.peaks(),multiplet_type:this.multiplet_type,
atoms:this.atoms(),atom_refs:this.atom_refs};rows.push(row)});c.select("tbody").remove();0<rows.length?c.append("tbody").selectAll("tr").data(rows).enter().append("tr").attr("data-cluster-path-id",function(a){return a.path_id}).selectAll("td").data(function(b,c){return a.map(function(a){var d={};d3.keys(a).forEach(function(e){d[e]="function"==typeof a[e]?a[e](b,c):a[e]});return d})}).enter().append("td").html(function(a){return a.html}).attr("class",function(a){return a.class}):c.append("tbody").append("tr").append("td").attr("colspan",
a.length).style("text-align","center").html("No Clusters");this.add_table_events();d3.selectAll(".atom-badge").each(function(){var a=d3.select(this),c=b.atoms(a.text());c&&a.classed("atom-badge-symbol-"+c.symbol,!0)});this.edit_mode?this.make_sortable():c.selectAll(".add-atoms").style("display","none")};d.prototype.make_sortable=function(){var b=this,c=this.table,a=this.struct;c.classed("editable",!0);c.selectAll("tbody tr .atom-cell").each(function(){Sortable.create(this,{draggable:".atom-badge",
group:"atoms",animation:150,ghostClass:"badge-ghost",onAdd:function(c){var d,k=b.cluster_from_table_child(c.item),l=b.cluster_from_table_child(c.from);(c=d3.select(c.item).attr("data-atom-id"))&&(d=a.atoms(c));if(d&&k&&l){var h=a.nmr_atoms_from_atoms([d]);atoms=k.atoms().merge(h).unique();k._atoms=atoms;l._atoms=new e.SVSet(l._atoms.filter(function(a){return!h.contains(a)}));b.update_table()}b.select_peaks_and_atoms(b.selected_atoms)},onEnd:function(c){if(c=d3.select(c.item).attr("data-atom-id"))atom=
a.atoms(c),b.selected_atoms=new e.SVSet(atom),b.select_peaks_and_atoms(b.selected_atoms)}})});c.selectAll("tbody tr td.peak-cell").each(function(){Sortable.create(this,{draggable:".peak-badge",group:"peaks",animation:150,ghostClass:"badge-ghost",onAdd:function(a){var c,d=b.cluster_from_table_child(a.item),e=b.cluster_from_table_child(a.from);(a=d3.select(a.item).attr("data-peak-id"))&&(c=sv.peaks(a));c&&d&&e&&(c.delete(),d.add_peak(c),d.update(),sv._cluster_navigation&&sv._cluster_navigation.update_table(),
b.update_table());b.select_peaks_and_atoms(b.selected_peaks)},onEnd:function(a){if(a=d3.select(a.item).attr("data-peak-id"))peak=sv.peaks(a),b.selected_peaks=new e.SVSet(peak),b.select_peaks_and_atoms(b.selected_peaks)}})})};d.prototype.add_table_events=function(){var b=this,c=this.table,a=this.sv,d=this.struct;c.selectAll("tbody tr").on("click",function(){c.selectAll("tbody tr").classed("selected",!1);d3.select(this).classed("selected",!0);var d=d3.select(this).attr("data-cluster-path-id"),d=a.clusters(d);
b.select_peaks_and_atoms(d)});c.selectAll("tbody .atom-badge").on("click",function(){var a=b.selected_atoms,c=d3.select(this).attr("data-atom-id"),c=d.atoms(c);d3.event.shiftKey?(window.getSelection().removeAllRanges(),a.contains(c)?a=a.remove(c):a.push(c)):a=new e.SVSet(c);b.selected_atoms=a;b.select_peaks_and_atoms(b.selected_atoms);d3.event.stopPropagation()});c.selectAll("tbody .peak-badge").on("click",function(){var c=b.selected_peaks,d=d3.select(this).attr("data-peak-id"),d=a.peaks(d);d3.event.shiftKey?
(window.getSelection().removeAllRanges(),c.contains(d)?c=c.remove(d):c.push(d)):c=new e.SVSet(d);b.selected_peaks=c;b.select_peaks_and_atoms(b.selected_peaks);d3.event.stopPropagation()});c.selectAll("tbody tr .add-atoms").on("click",function(){var a=b.cluster_from_table_child(this);a&&(a._atoms=d.nmr_atoms_from_atoms(d.selected_atoms));d3.event.stopPropagation();b.update_table();b.select_peaks_and_atoms(a);return!1})};d.prototype.add_sv_events=function(){var b=this,c=b.struct,a=b.sv;a.on("adjust-end.assign",
function(){b.update_table();b.select_peaks_and_atoms(a.selection.peaks())});a.on("adjust-peak-created.assign",function(a){a=a.cluster();1==a.peaks().length&&(a._atoms=c.nmr_atoms_from_atoms(c.selected_atoms))});a.on("selection-add.assign",function(){b.select_peaks_and_atoms(a.selection.peaks())});a.on("selection-remove.assign",function(){b.select_peaks_and_atoms(a.selection.peaks())});a.on("selection-clear.assign",function(){b.select_peaks_and_atoms(void 0)})};d.prototype.add_struct_events=function(){var b=
this,c=this.struct;c.on("structure-click.assign",function(){c.selected_atoms=c.LCA_and_nmr_atoms(c.selected_atoms);b.select_peaks_and_atoms(c.selected_atoms)})};d.prototype.select_peaks_and_atoms=function(b){var c=this.sv,a=this.struct,d=this.table,f,k=new e.SVSet,l=new e.SVSet;b&&("Cluster"==b.toString()?f=b:"SVSet"==b.toString()||Array.isArray(b)?b[0]&&("Atom"==b[0].toString()?l=b:"Peak"==b[0].toString()&&(k=b)):console.log("Unknown Selection"));k.present()&&(f=this.cluster_from_peaks(k));l.present()&&
(f=this.cluster_from_atoms(l));f&&(k=f.peaks(),l=f.atoms());a&&(a.selected_atoms=a.LCA_and_nmr_atoms(l));c.selection._elements=k.unique();c.draw();this.selected_peaks=k;a&&(this.selected_atoms=a.LCA_from_nmr_atoms(l));d.selectAll("tbody tr").classed("selected",!1);f&&d.select("tbody tr[data-cluster-path-id="+f.path_id()+"]").classed("selected",!0)};d.prototype.cluster_from_peaks=function(b){var c;this.sv.clusters().forEach(function(a){a.peaks().equals(b)&&(c=a)});return c};d.prototype.cluster_from_atoms=
function(b){var c,a=this.struct,d=a.nmr_atoms_from_atoms(b);this.sv.clusters().forEach(function(b){a.nmr_atoms_from_atoms(b.atoms()).equals(d)&&(c=b)});return c};d.prototype.cluster_from_table_child=function(b){if(b){for(var c,a=!1;!a;)if(localName=b.localName.toUpperCase(),"TR"==localName){var a=!0,d=d3.select(b).attr("data-cluster-path-id");d&&(c=this.sv.clusters(d))}else"TABLE"==localName?a=!0:(b=b.parentNode)||(a=!0);return c}};Object.defineProperties(d.prototype,{selected_atoms:{get:function(){var b=
this,c=new e.SVSet;this.container.selectAll(".atom-badge.selected").each(function(){var a=d3.select(this).attr("data-atom-id");c.push(b.struct.atoms(a))});return c},set:function(b){var c=this.container;c.selectAll(".atom-badge").classed("selected",!1);b.forEach(function(a){c.selectAll('.atom-badge[data-atom-id="'+a.id+'"]').classed("selected",!0)})}},selected_peaks:{get:function(){var b=this,c=new e.SVSet;this.container.selectAll(".peak-badge.selected").each(function(){var a=d3.select(this).attr("data-peak-id");
c.push(b.sv.peaks(a))});return c},set:function(b){var c=this.container;c.selectAll(".peak-badge").classed("selected",!1);b.forEach(function(a){c.select('.peak-badge[data-peak-id="'+a.path_id()+'"]').classed("selected",!0)})}},edit_mode:{get:function(){return this._edit_mode},set:function(b){var c=this.sv;(this._edit_mode=b)?(c.selection.element_type="peak",c.selection.allow_multiselect=!0,c.selection.allow_adjust=!0,c.selection.allow_width_adjust=!0,c.selection.allow_peak_creation=!0,c.highlight.element_type=
"peak"):(c.selection.element_type="cluster",c.selection.allow_multiselect=!0,c.selection.allow_adjust=!1,c.selection.allow_width_adjust=!1,c.selection.allow_peak_creation=!1,c.highlight.element_type="cluster");this.update_table();this.select_peaks_and_atoms(c.selection.peaks());c.draw()}},nmr_nucleus:{get:function(){return this._nmr_nucleus},set:function(b){this._nmr_nucleus=b;this.columns=this.get_columns();this.struct.nmr_nucleus=b;this.update_table_header();this.update_table()}}});e.SVAssignments=
d})(JSpectraViewer);JSpectraViewer.initialize();
